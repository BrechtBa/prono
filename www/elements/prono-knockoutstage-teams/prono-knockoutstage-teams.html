
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/default-dialog/default-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module id="prono-knockoutstage-teams">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.stage{
				transition: width 0.5s;
				-webkit-transition: width 0.5s;
			}
			.stage.expanded{
				@apply(--layout-flex-5);
			}
			.stage.collapsed{
				@apply(--layout-flex-2);
			}
			paper-material{
				cursor: pointer;
      			margin: 5px;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
				border-radius: 2px;
    		}
			paper-material h3{
				margin-top: 0px;
			}
			.stage{
				position: relative;
			}
			.stage.disabled::after{
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(1,1,1,0.3);
				border-radius: 2px;
			}
			.team{
				width: 24%;
				min-width: 140px;
			}
			.teamicon{
				width: 90%;
				max-width: 30px;
				height: auto;
				margin-top: 1px;
				margin-bottom: 1px;
				margin-right: 5px;
			}
			.teamname{
				text-align: center;
				margin-top: 5px;
				margin-bottom: 5px;
			}
			.selected{
				background-color: #dddddd;
			}
		</style>

		<api-model id="prono" token="{{token}}" url="../../api/index.php/prono_knockoutstage_teams/user_id/{{user.id}}" model="{{prono}}" on-change="handlePronoChange"></api-model>
		<api-model id="allProno" token="{{token}}" url="../../api/index.php/prono_knockoutstage_teams/" model="{{allProno}}" on-change="handleAllPronoChange"></api-model>

		<div class="horizontal layout center-justified">
			<div class="flex vertical layout">
				<template is="dom-repeat" items="{{stages}}" as="stage">

					<div class$="stage {{stageClass(stage)}} {{disabledClass(currentStage)}} vertical-layout">
						<paper-material elevation="2" class="match vertical layout" on-tap="editTeams">
							<h3>{{formatStageText(stage)}}</h3>
							<div class="horizontal layout center-justified wrap">
								<template is="dom-repeat" items="{{getPronoTeamStage(teamsModel,prono,stage)}}" as="team" sort="_sortTeams">
									<div class="team horizontal layout center">
										<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
										<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
									</div>
								</template>
							</div>
						</paper-material>
					</div>

				</template>
			</div>
		</div>

		<default-dialog id="editTeams">
			<div class="before-scrolling">{{selectionsRemaining}} selections remaining</div>
			<form is="iron-form" id="form" method="post" on-iron-form-submit="save" action="/">

				<template is="dom-repeat" items="{{teamsModel}}" as="team">
	        		<div class$="horizontal layout center {{selectedClass(team,selectedTeams)}}" on-tap="selectTeam">
						<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
						<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
					</div>
				</template>

				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmit">Save</paper-button>
					<button type="submit" style="display:none;">Save</button>
				</div>
			</form>
		</default-dialog>

	</template>

	<script>
		Polymer({
			is: 'prono-knockoutstage-teams',
			properties: {
				token:{
					type: 'String',
					value: ''
				},
				teamsModel: {
					type: 'Array',
					value: []
				},
				matchesModel: {
					type: 'Array',
					value: []
				},
				currentStage: {
					type: 'Number',
					value: -1
				},
				user: {
					type: 'Object',
					value: {}
				},
				permission: {
					type: 'Number',
					value: 1
				}
			},
			ready: function(){
				console.log('ready');
				// add global event listeners
				var that = this;
				document.addEventListener('prono-model-changed', function (e) {
					that.getStages();
				});
			},
			getStages: function(){
				var stages = [];
				this.matchesModel.forEach(function(match){
					if(match.stage > 0 && stages.indexOf(match.stage)==-1){
						stages.push(match.stage);
					}
				});
				stages.push("1");
				
				this.stages = stages;
				this.$.prono.get();
			},
			handlePronoChange: function(){
				var done = true;
				console.log('check prono knockoutstage teams');
				try{
					var that = this;
					// check which prono's should be present
					var pronos = [];
					this.stages.forEach(function(stage){
						for(var i=1; i<=stage; i++){
							pronos.push('stage' + stage + '_'+ i);
						}
					});

					pronos.every(function(prono_id){
						// check if the prono is in pronoTeam
						var found = false;
						that.prono.forEach(function(tempprono){
							if(tempprono.prono_id == prono_id){
								found = true;
							}
						});

						if(!found){
							done = false;
							// post the prono
							console.log('adding prono team '+prono_id);
							that.$.prono.post({'user_id':that.user.id,'prono_id':prono_id,'team_id':-1});
						}
						return found;				
					});
				}
				catch(e){
				}
			
				// proceed to the next step
				if(done){
					this.$.allProno.get();
				}
			},
			handleAllPronoChange: function(){
				// calculate the points for every user if permitted and fire an event which says these have changed


				points = {}
				this.fire('prono-knockoutstage-teams-points-changed',points)
			},
			getPronoTeamStage: function(teamsModel,prono,stage){
				var teams = []

				var stageProno = this.prono.filter(function(prono){
					return ( prono.prono_id.indexOf('stage' + stage + '_')>-1 );
				});

				stageProno.forEach(function(prono){
					var team = teamsModel.filter(function(team){
						return team.id == prono.team_id;
					});
					if(team.length>0){
						teams.push( team[0] );
					}
				});

				return teams;
			},
			formatStageText: function(stage){
				var text = ''
				switch(stage){
					case '16':
						text = 'Teams in round of 16:';
						break;
					case '8':
						text = 'Teams in quarterfinal:';
						break;
					case '4':
						text = 'Teams in semifinal:';
						break;
					case '2':
						text = 'Teams in final:';
						break;
					case '1':
						text = 'Winner';
						break;
					default:
						text = '';
				}
				return text;
			},
			stageClass: function(stage){
				return 'stage-'+stage;
			},
			disabledClass: function(stage){
				if(stage==0){
					return '';
				}
				else{
					return 'disabled';
				}
			},
			formatTeamName: function(id,teamsModel){
				var name = '';
				teamsModel.forEach(function(item){
					if(item.id == id){
						name = item.name;
					}
				});
				return name;
			},
			getTeam: function(id,teamsModel){
				var team = {};
				teamsModel.forEach(function(item){
					if(item.id == id){					
						team = item;
					}
				});
				return team;
			},
			editTeams: function(e){
				var editStage = e.model.__data__.stage;
				this.editStage = editStage;

				var selectedTeams = []
				var stageProno = this.prono.filter(function(prono){
					return ( prono.prono_id.indexOf('stage' + editStage + '_')>-1 );
				});

				stageProno.forEach(function(prono){
					if(prono.team_id>0){
						selectedTeams.push(prono.team_id);
					}
				});
				this.selectedTeams = selectedTeams;
				this.selectionsRemaining = parseInt(editStage) - this.selectedTeams.length

				this.$.editTeams.open();
			},
			selectTeam: function(e){
				var team_id = e.model.__data__.team.id;

				var selectedTeams = JSON.parse(JSON.stringify(this.selectedTeams));
				var index = selectedTeams.indexOf(team_id);
				if( index > -1 ){
					// remove the team
					selectedTeams.splice(index, 1);
				}
				else if(parseInt(this.editStage) - this.selectedTeams.length > 0){
					// add the team
					selectedTeams.push(team_id);
				}
				this.selectedTeams = selectedTeams;

				this.selectionsRemaining = parseInt(this.editStage) - this.selectedTeams.length;
			},
			selectedClass: function(team,selectedTeams){
				if( selectedTeams.indexOf(team.id)>-1){
					return 'selected';
				}
				else{
					return '';
				}
			},
			formSubmit: function(){
				this.$.form.submit();
			},
			save: function(){
				this.$.editTeams.close();

				var that = this;
				var teams = this.teamsModel.filter(function(team){
					return (that.selectedTeams.indexOf(team.id)>-1);
				});			
				teams.sort(this._sortTeams);
				console.log(teams);

				for(var i=1; i<=this.editStage; i++){
					if(typeof teams[i-1] != 'undefined'){
						this.$.prono.put('prono_id/stage' + this.editStage + '_' + i,{'team_id':teams[i-1].id});
					}
					else{
						this.$.prono.put('prono_id/stage' + this.editStage + '_' + i,{'team_id':-1});
					}
				}
			},
			_sortTeams: function(a, b) {  
  
				if( a.name > b.name ){
					return 1;
				}
				else if( a.name < b.name ){
					return -1;
				}
				else{
					return 0;
				}
			},
		});
	</script>

</dom-module>
