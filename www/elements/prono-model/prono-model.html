
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>
		
		<iron-ajax id="getTeams" url="../../api/index.php/teams" method="GET" handle-as="json" last-response="{{teams}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getGroups" url="../../api/index.php/groups" method="GET" handle-as="json" last-response="{{groups}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getMatches" url="../../api/index.php/matches" method="GET" handle-as="json" last-response="{{matchess}}" on-response="handleGetMatchesResponse"  debounce-duration="300"></iron-ajax>
		<iron-ajax id="getBetsScore" url="../../api/index.php/bets_score" method="GET" handle-as="json" last-response="{{betsScore}}" on-response="handleGetBetsScoreResponse" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="postBetsScore" url="../../api/index.php/bets_score" method="POST" handle-as="json" last-response="{{betsScore}}" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="getRules" url="../../api/index.php/rules/1" method="GET" handle-as="json" last-response="{{rules}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getUsers" url="../../api/index.php/user_profiles" method="GET" handle-as="json" last-response="{{users}}" on-response="handleGetUsersResponse" debounce-duration="300"></iron-ajax>		
		<iron-ajax id="putUsers" url="../../api/index.php/user_profiles" method="PUT" handle-as="json" on-response="handlePutUsersResponse" debounce-duration="300"></iron-ajax>		
		
		<iron-ajax id="getAllBetsScore" url="../../api/index.php/bets_score" method="GET" handle-as="json" last-response="{{allBetsScore}}" on-response="handleGetAllBetsScoreResponse" debounce-duration="300"></iron-ajax>
		

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
					notify: true,
					observer: 'tokenChanged'
				},
				rules: {
					type: 'Array',
					value: [],
					notify: true
				},
				users: {
					type: 'Array',
					value: [],
					notify: true
				},
				user: {
					type: 'Object',
					notify: true
				},
				groups: {
					type: 'Array',
					value: [],
					notify: true
				},
				teams: {
					type: 'Array',
					value: [],
					notify: true
				},
				matchess: {
					type: 'Array',
					value: [],
					notify: true
				},
				betsScore: {
					type: 'Array',
					value: [],
					notify: true
				},
				allBetsScore: {
					type: 'Array',
					value: [],
					notify: false
				},
			},
			listeners: {
				'get-teams': 'getTeams',
				'get-groups': 'getGroups',
				'get-matches': 'getMatches',
				'get-bets-score': 'getBetsScore',
				'get-users': 'getUsers',
			},
			tokenChanged: function(){
				if( this.token != ''){
					this.getRules();
					this.getUsers();
					this.getTeams();
					this.getGroups();
					this.getMatches();
					if(this.tokenPayload.permission>5){
						this.getAllBetsScore();
					}
				}
				else{
					this.teams = [];
					this.groups = [];
					this.matchess = [];
					this.betsScore = [];
				}
			},
			getRules: function(){
				console.log('getting rules');
				this.$.getRules.headers['Authentication'] = this.token;
				this.$.getRules.generateRequest();
			},
			getUsers: function(){
				console.log('getting users');
				this.$.getUsers.headers['Authentication'] = this.token;
				this.$.getUsers.generateRequest();
			},
			getTeams: function(){
				console.log('getting teams');
				this.$.getTeams.headers['Authentication'] = this.token;
				this.$.getTeams.generateRequest();
			},
			getGroups: function(){
				console.log('getting groups');
				this.$.getGroups.headers['Authentication'] = this.token;
				this.$.getGroups.generateRequest();
			},
			getMatches: function(){
				console.log('getting matches');
				this.$.getMatches.headers['Authentication'] = this.token;
				this.$.getMatches.generateRequest();
			},
			getBetsScore: function(){
				console.log('getting bets score for user ' +this.tokenPayload.user_id);
				this.$.getBetsScore.headers['Authentication'] = this.token;
				this.$.getBetsScore.url = 'api/index.php/bets_score/user_id/'+this.tokenPayload.user_id
				this.$.getBetsScore.generateRequest();
			},
			getAllBetsScore: function(){
				if(this.tokenPayload.permission>5){
					this.$.getAllBetsScore.headers['Authentication'] = this.token;
					this.$.getAllBetsScore.generateRequest();
				}
			},
			handleGetUsersResponse: function(){
				that = this;	
				that.users.forEach(function(user){
					if(user.user_id == that.tokenPayload.user_id){
						that.user = user;
					}
				});
			},
			handleGetMatchesResponse: function(){
				this.getBetsScore();
				
				if(this.tokenPayload.permission>5){
					this.calculatePoints();
				}
			},
			handleGetBetsScoreResponse: function(){
				that = this;
				that.matchess.forEach(function(match){
					// check if the match_id is in betsScore
					var found = false;
					that.betsScore.forEach(function(bet){
						if(bet.match_id == match.id){
							found = true;
						}
					});

					if(!found){
						// post the match
						that.$.postBetsScore.headers['Authentication'] = that.token;
						that.$.postBetsScore.url = 'api/index.php/bets_score';
						that.$.postBetsScore.body = JSON.stringify({'user_id':that.tokenPayload.user_id,'match_id':match.id,'score1':-1,'score2':-1,'penalty1':-1,'penalty2':-1});
						that.$.postBetsScore.generateRequest();
					}
				});
			},
			handleGetAllBetsScoreResponse: function(){
			},
			handlePutUsersResponse: function(){
				this.getUsers();
			},
			calculatePoints: function(){
				if(this.tokenPayload.permission>5){

					if( this.rules != [] && this.users != [] && this.groups != [] && this.teams != [] && this.matchess != [] && this.allBetsScore.length > 0 ){
						var that = this;
						console.log('calculate points')
						that.users.forEach(function(user){
							var points = 0;

							// get the users score bets
							var bets = that.allBetsScore.filter(function( bet ){
								return ( bet.user_id==user.id );
							});

							points += that.countCorrectResults(bets,0)*3;//*that.rules[0]['groupstage_result'];	
							points += that.countCorrectResults(bets,16)*6;//*that.rules[0]['knockoutstage_result'];	
							points += that.countCorrectResults(bets,8)*6;//*that.rules[0]['knockoutstage_result'];	
							points += that.countCorrectResults(bets,4)*6;//*that.rules[0]['knockoutstage_result'];	
							points += that.countCorrectResults(bets,2)*6;//*that.rules[0]['knockoutstage_result'];	

							points += that.countCorrectScores(bets,0)*4;//*that.rules[0]['groupstage_score'];	
							points += that.countCorrectScores(bets,16)*8;//*that.rules[0]['knockoutstage_score'];	
							points += that.countCorrectScores(bets,8)*8;//*that.rules[0]['knockoutstage_score'];	
							points += that.countCorrectScores(bets,4)*8;//*that.rules[0]['knockoutstage_score'];	
							points += that.countCorrectScores(bets,2)*8;//*that.rules[0]['knockoutstage_score'];	

							user.points = points;

							// write points to database
							that.$.putUsers.headers['Authentication'] = that.token;
							that.$.putUsers.url = 'api/index.php/user_profiles/user_id/'+user.id;
							that.$.putUsers.body = JSON.stringify({'points':points});
							that.$.putUsers.generateRequest();
						});
					}
				}
			},
			countCorrectResults(bets,stage){
				var that = this;
				
				// get the matches of the stage
				var matches = that.matchess.filter(function( match ){
					return ( match.stage==stage );
				});

				var count = 0;
				matches.forEach(function(match){
					// find the users bet					
					var bet = bets.filter(function( bet ){
						return ( bet.match_id==match.id );
					});
					bet = bet[0];
					
					if(match.score1>-1 && match.score2 >-1){
						if( (bet.score1>bet.score2 && match.score1>match.score2) || (bet.score1<bet.score2 && match.score1<match.score2) || (bet.score1==bet.score2 && match.score1==match.score2) ){
							count += 1;
						}
					}

				});
				return count;
			},
			countCorrectScores(bets,stage){
				var that = this;
				
				// get the matches of the stage
				var matches = that.matchess.filter(function( match ){
					return ( match.stage==stage );
				});

				var count = 0;
				matches.forEach(function(match){
					// find the users bet					
					var bet = bets.filter(function( bet ){
						return ( bet.match_id==match.id );
					});
					bet = bet[0];
					
					if(match.score1>-1 && match.score2 >-1){
						if( (bet.score1==match.score1 && bet.score2==match.score2) ){
							count += 1;
						}
					}

				});
				return count;
			},
	
		});
	</script>

</dom-module>
