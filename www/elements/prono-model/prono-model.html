
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>
		<iron-ajax id="getTeams" url="../../api/index.php/teams" method="GET" handle-as="json" last-response="{{teams}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getGroups" url="../../api/index.php/groups" method="GET" handle-as="json" last-response="{{groups}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getMatches" url="../../api/index.php/matches" method="GET" handle-as="json" last-response="{{matchess}}" on-response="handleGetMatchesResponse"  debounce-duration="300"></iron-ajax>
		<iron-ajax id="getBetsScore" url="../../api/index.php/bets_score" method="GET" handle-as="json" last-response="{{betsScore}}" on-response="handleGetBetsScoreResponse" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="postBetsScore" url="../../api/index.php/bets_score" method="POST" handle-as="json" last-response="{{betsScore}}" debounce-duration="300"></iron-ajax>
		
	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
					notify: true,
					observer: 'tokenChanged'
				},
				groups: {
					type: 'Array',
					value: [],
					notify: true
				},
				teams: {
					type: 'Array',
					value: [],
					notify: true
				},
				matchess: {
					type: 'Array',
					value: [],
					notify: true
				},
				betsScore: {
					type: 'Array',
					value: [],
					notify: true
				},
			},
			listeners: {
				'get-teams': 'getTeams',
				'get-groups': 'getGroups',
				'get-matches': 'getMatches',
				'get-bets-score': 'getBetsScore',
			},
			tokenChanged: function(){
				if( this.token != ''){
					this.getTeams();
					this.getGroups();
					this.getMatches();
				}
				else{
					this.teams = [];
					this.groups = [];
					this.matchess = [];
					this.betsScore = [];
				}
			},
			getTeams: function(){
				console.log('getting teams');
				this.$.getTeams.headers['Authentication'] = this.token;
				this.$.getTeams.generateRequest();
			},
			getGroups: function(){
				console.log('getting groups');
				this.$.getGroups.headers['Authentication'] = this.token;
				this.$.getGroups.generateRequest();
			},
			getMatches: function(){
				console.log('getting matches');
				this.$.getMatches.headers['Authentication'] = this.token;
				this.$.getMatches.generateRequest();
			},
			handleGetMatchesResponse: function(){
				this.getBetsScore();
			},
			getBetsScore: function(){
				console.log('getting bets score for user ' +this.tokenPayload.user_id);
				this.$.getBetsScore.headers['Authentication'] = this.token;
				this.$.getBetsScore.url = 'api/index.php/bets_score/user_id/'+this.tokenPayload.user_id
				this.$.getBetsScore.generateRequest();
			},
			handleGetBetsScoreResponse: function(){
				that = this;
				that.matchess.forEach(function(match){
					// check if the match_id is in betsScore
					var found = false;
					that.betsScore.forEach(function(bet){
						if(bet.match_id == match.id){
							found = true;
						}
					});

					if(!found){
						// post the match
						that.$.postBetsScore.headers['Authentication'] = that.token;
						that.$.postBetsScore.url = 'api/index.php/bets_score';
						that.$.postBetsScore.body = JSON.stringify({'user_id':that.tokenPayload.user_id,'match_id':match.id,'score1':-1,'score2':-1,'penalty1':-1,'penalty2':-1});
						that.$.postBetsScore.generateRequest();
					}
				});
			}
		});
	</script>

</dom-module>
