
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>

		<!--<api-model token="[[token]]" url="api/index.php/teams" model="{{teamsModel}}"></api-model>
		<api-model token="[[token]]" url="api/index.php/matches" model="{{matchesModel}}"></api-model>

		<api-model token="[[token]]" url="api/index.php/rules" model="{{rulesModel}}"></api-model>
		<api-model token="[[token]]" url="api/index.php/users_profiles" model="{{usersModel}}"></api-model>

		<api-model token="[[token]]" url="api/index.php/prono_score/user_id/{{}}" model="{{pronoScoreModel}}"></api-model>
		<api-model token="[[token]]" url="api/index.php/prono_team" model="{{pronoTeamModel}}"></api-model>
		<api-model token="[[token]]" url="api/index.php/prono_stage" model="{{pronoStageModel}}"></api-model>
		<api-model token="[[token]]" url="api/index.php/prono_number" model="{{pronoNumberModel}}"></api-model>-->
		

		<iron-ajax id="getTeams" url="../../api/index.php/teams" method="GET" handle-as="json" last-response="{{teams}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getGroups" url="../../api/index.php/groups" method="GET" handle-as="json" last-response="{{groups}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getMatches" url="../../api/index.php/matches" method="GET" handle-as="json" last-response="{{matchess}}" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="getPronoScore" url="../../api/index.php/prono_score" method="GET" handle-as="json" last-response="{{pronoScore}}" on-response="checkPronoScore" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getPronoTeam" url="../../api/index.php/prono_team" method="GET" handle-as="json" last-response="{{pronoTeam}}"  on-response="checkPronoTeam" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getPronoStage" url="../../api/index.php/prono_stage" method="GET" handle-as="json" last-response="{{pronoStage}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getPronoNumber" url="../../api/index.php/prono_number" method="GET" handle-as="json" last-response="{{pronoNumber}}" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="postPronoScore" url="../../api/index.php/prono_score" method="POST" handle-as="json" on-response="handlePostPronoScoreResponse" debounce-duration="300"></iron-ajax>
		<iron-ajax id="postPronoTeam" url="../../api/index.php/prono_team" method="POST" handle-as="json" debounce-duration="300"></iron-ajax>
		<iron-ajax id="postPronoStage" url="../../api/index.php/prono_stage" method="POST" handle-as="json" debounce-duration="300"></iron-ajax>
		<iron-ajax id="postPronoNumber" url="../../api/index.php/prono_number" method="POST" handle-as="json" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="getRules" url="../../api/index.php/rules/1" method="GET" handle-as="json" last-response="{{rules}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getUserProfiles" url="../../api/index.php/user_profiles" method="GET" handle-as="json" last-response="{{users}}" on-response="checkUserProfile" debounce-duration="300"></iron-ajax>
		<iron-ajax id="putUserProfiles" url="../../api/index.php/user_profiles" method="PUT" handle-as="json" on-response="handlePutUserProfilesResponse" debounce-duration="300"></iron-ajax>		
		<iron-ajax id="postUserProfiles" url="../../api/index.php/user_profiles" method="POST" handle-as="json" on-response="handlePostUserProfilesResponse" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="getAllPronoScore" url="../../api/index.php/prono_score" method="GET" handle-as="json" last-response="{{allPronoScore}}" debounce-duration="300"></iron-ajax>
		

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
					notify: true,
					observer: 'tokenChanged'
				},
				rules: {
					type: 'Array',
					notify: true
				},
				users: {
					type: 'Array',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true
				},
				teams: {
					type: 'Array',
					notify: true
				},
				matchess: {
					type: 'Array',
					notify: true
				},
				groups: {
					type: 'Array',
					notify: true,
					computed: 'getGroups(matchess)'
				},
				stages: {
					type: 'Array',
					notify: true,
					computed: 'getStages(matchess)'
				},
				pronoScore: {
					type: 'Array',
					notify: true
				},
				pronoTeam: {
					type: 'Array',
					notify: true
				},
				allPronoScore: {
					type: 'Array',
					notify: false
				},
			},
			listeners: {
				'get-rules': 'getRules',
				'get-users': 'getUsers',
				'get-teams': 'getTeams',
				'get-matches': 'getMatches',
				'get-prono-score': 'getPronoScoreEvent',
				'get-prono-team': 'getPronoTeamEvent',
			},
			observers: [
				'getPronoScore(token,tokenPayload,matchess)',
				'getPronoTeam(token,tokenPayload,groups,stages,teams)',
				'calculatePoints(token,tokenPayload,users,rules,groups,stages,teams,matchess,allPronoScore)'
			],
			tokenChanged: function(){
				this.getRules();
				this.getUsers();
				this.getTeams();
				this.getMatches();
			},
			getRules: function(){
				if( this.token != ''){
					console.log('getting rules');
					this.$.getRules.headers['Authentication'] = this.token;
					this.$.getRules.generateRequest();
				}
				else{
					this.rules = [];
				}
			},
			getUsers: function(){
				if( this.token != ''){
					console.log('getting users');
					this.$.getUserProfiles.headers['Authentication'] = this.token;
					this.$.getUserProfiles.generateRequest();
				}
				else{
					this.users = [];
					this.user = {};
				}
			},
			getTeams: function(){
				if( this.token != ''){
					console.log('getting teams');
					this.$.getTeams.headers['Authentication'] = this.token;
					this.$.getTeams.generateRequest();
				}
				else{
					this.teams = [];
				}
			},
			getMatches: function(){
				if( this.token != ''){
					console.log('getting matches');
					this.$.getMatches.headers['Authentication'] = this.token;
					this.$.getMatches.generateRequest();
				}
				else{
					this.matchess = [];
				}
				this.getAllPronoScore();
			},
			getAllPronoScore: function(){
				if(this.token != '' && this.tokenPayload.permission>5){
					console.log('getting all prono score');
					this.$.getAllPronoScore.headers['Authentication'] = this.token;
					this.$.getAllPronoScore.generateRequest();
				}
				else{
					this.allPronoScore = [];
				}
			},
			getGroups: function(matchess){
				var groups = [];
				try{
					matchess.forEach(function(match){
						if(match.stage == 0 && groups.indexOf(match.grp)==-1){
							groups.push(match.grp);
						}
					});
				}
				catch(e){
				}
				return groups;
			},
			getStages: function(matchess){
				var stages = [];
				try{
					matchess.forEach(function(match){
						if(match.stage > 0 && stages.indexOf(match.stage)==-1){
							stages.push(match.stage);
						}
					});
				}				
				catch(e){
				}
				return stages;
			},
			getPronoScoreEvent: function(){
				this.getPronoScore(this.token,this.tokenPayload);
			},
			getPronoScore: function(token,tokenPayload,matchess){
				try{
					console.log('getting prono score for user ' + tokenPayload.user_id);
					this.$.getPronoScore.headers['Authentication'] = token;
					this.$.getPronoScore.url = 'api/index.php/prono_score/user_id/'+ tokenPayload.user_id
					this.$.getPronoScore.generateRequest();
				}
				catch(e){
					this.pronoScore = [];
				}
			},
			getPronoTeamEvent: function(){
				this.getPronoTeam(this.token,this.tokenPayload);
			},
			getPronoTeam: function(token,tokenPayload,groups,stages,teams){
				try{
					console.log('getting prono team for user ' +tokenPayload.user_id);
					this.$.getPronoTeam.headers['Authentication'] = token;
					this.$.getPronoTeam.url = 'api/index.php/prono_team/user_id/'+tokenPayload.user_id
					this.$.getPronoTeam.generateRequest();
				}
				catch(e){
					this.pronoTeam = [];
				}
			},
			getPronoStage: function(token,tokenPayload,stages){
				try{
					console.log('getting prono stage for user ' +tokenPayload.user_id);
					this.$.getPronoStage.headers['Authentication'] = token;
					this.$.getPronoStage.url = 'api/index.php/prono_stage/user_id/'+tokenPayload.user_id
					this.$.getPronoStage.generateRequest();
				}
				catch(e){
					this.pronoStage = [];
				}
			},
			getPronoNumber: function(token,tokenPayload){
				try{
					console.log('getting prono number for user ' +tokenPayload.user_id);
					this.$.getPronoNumber.headers['Authentication'] = token;
					this.$.getPronoNumber.url = 'api/index.php/prono_number/user_id/'+tokenPayload.user_id
					this.$.getPronoNumber.generateRequest();
				}
				catch(e){
					this.pronoNumber = [];
				}
			},
			checkUserProfile: function(){
				try{
					var that = this;
					var user = that.users.filter(function( item ) {
						return item.user_id == that.tokenPayload.user_id;
					});
					if(user.length > 0){
						this.user = user[0];
					}
					else{
						// the user has no profile, it must be created
						that.$.postUserProfiles.headers['Authentication'] = this.token;
						that.$.postUserProfiles.url = 'api/index.php/user_profiles';
						that.$.postUserProfiles.body = JSON.stringify({'user_id': this.tokenPayload.user_id, 'name': this.tokenPayload.login, 'avatar': ''});
						that.$.postUserProfiles.generateRequest();
					}
				}
				catch(e){
					this.user = {};
				}
			},
			handlePostUserProfilesResponse: function(){
				this.getUsers();
			},
			checkPronoScore: function(){
				try{
					var that = this;
					var reload = false;
					this.matchess.forEach(function(match){
				
						// check if the match_id is in pronoScore
						var found = false;
						that.pronoScore.forEach(function(prono){
							if(prono.match_id == match.id){
								found = true;
							}
						});

						if(!found ){
							reload = true;
							// the match has no prono, it must be created
							var data = {'user_id':that.tokenPayload.user_id,'match_id':match.id,'score1':-1,'score2':-1,'penalty1':-1,'penalty2':-1};
							
							that.$.postPronoScore.headers['Authentication'] = that.token;
							that.$.postPronoScore.url = 'api/index.php/prono_score';
							that.$.postPronoScore.body = JSON.stringify(data);
							that.$.postPronoScore.generateRequest();
							that.push('pronoScore',data);
						}
					});
					if(reload){
						// wait for a while						
						setTimeout(function(){
							that.getPronoScore(that.token,that.tokenPayload,that.matchess);
						},5000);
					}
				}
				catch(e){
				}
			},
			handlePostPronoScoreResponse: function(){
			},
			checkPronoTeam: function(){
				try{
					var that = this;
					// check which prono's should be present
					var pronos = []
					// group winner and runner up
					this.groups.forEach(function(group){
						pronos.push(group + '1');
						pronos.push(group + '2');
					});
					// knockoutstage teams
					this.stages.forEach(function(stage){
						for(var i=1; i<=stage; i++){
							pronos.push('stage' + stage + '_'+ i);
						}
					});

					var reload = false;
					pronos.forEach(function(prono){
						// check if the prono is in pronoTeam
						var found = false;
						pronoTeam.forEach(function(tempprono){
							if(tempprono.prono == prono){
								found = true;
							}
						});

						if(!found){
							reload = true;
							// post the prono
							var data = {'user_id':that.tokenPayload.user_id,'prono':prono,'team_id':-1};
							that.$.postPronoTeam.headers['Authentication'] = that.token;
							that.$.postPronoTeam.url = 'api/index.php/prono_team';
							that.$.postPronoTeam.body = JSON.stringify(data);
							that.$.postPronoTeam.generateRequest();
							that.push('pronoTeam',data);
							console.log(data);
						}
					});
					if(reload){
						// wait for a while						
						setTimeout(function(){
							that.getPronoTeam(that.token,that.tokenPayload,that.groups,that.stages,that.teams);
						},5000);
					}
				}
				catch(e){
				}
			},
			handlePostPronoTeamResponse: function(){
			},
			handlePutUserProfilesResponse: function(){
				this.getUsers();
			},
			calculatePoints: function(token,tokenPayload,users,rules,groups,stages,teams,matchess,allPronoScore){
				if(tokenPayload.permission>5){

					var that = this;
					console.log('calculate points')

					users.forEach(function(user){
						var points = 0;

						// get the users score prono
						var prono = allPronoScore.filter(function( prono ){
							return ( prono.user_id==user.id );
						});
						
						points += that.countCorrectResults(prono,0)*3;//*that.rules[0]['groupstage_result'];	
						points += that.countCorrectResults(prono,16)*6;//*that.rules[0]['knockoutstage_result'];	
						points += that.countCorrectResults(prono,8)*6;//*that.rules[0]['knockoutstage_result'];	
						points += that.countCorrectResults(prono,4)*6;//*that.rules[0]['knockoutstage_result'];	
						points += that.countCorrectResults(prono,2)*6;//*that.rules[0]['knockoutstage_result'];	

						points += that.countCorrectScores(prono,0)*4;//*that.rules[0]['groupstage_score'];	
						points += that.countCorrectScores(prono,16)*8;//*that.rules[0]['knockoutstage_score'];	
						points += that.countCorrectScores(prono,8)*8;//*that.rules[0]['knockoutstage_score'];	
						points += that.countCorrectScores(prono,4)*8;//*that.rules[0]['knockoutstage_score'];	
						points += that.countCorrectScores(prono,2)*8;//*that.rules[0]['knockoutstage_score'];	
			

						if(user.points != points){
							// write points to database
							that.$.putUserProfiles.headers['Authentication'] = that.token;
							that.$.putUserProfiles.url = 'api/index.php/user_profiles/user_id/'+user.id;
							that.$.putUserProfiles.body = JSON.stringify({'points':points});
							that.$.putUserProfiles.generateRequest();
						}
					});
					
				}
			},
			countCorrectResults(prono,stage){
				var that = this;
				
				// get the matches of the stage
				var matches = that.matchess.filter(function( match ){
					return ( match.stage==stage );
				});

				var count = 0;
				matches.forEach(function(match){
					// find the users bet					
					var bet = prono.filter(function( bet ){
						return ( bet.match_id==match.id );
					});
					bet = bet[0];

					if(typeof bet != 'undefined' && match.score1>-1 && match.score2 >-1 && bet.score1>-1 && bet.score2 >-1){
						if( (bet.score1>bet.score2 && match.score1>match.score2) || (bet.score1<bet.score2 && match.score1<match.score2) || (bet.score1==bet.score2 && match.score1==match.score2) ){
							count += 1;
						}
					}

				});
				return count;
			},
			countCorrectScores(prono,stage){
				var that = this;
				
				// get the matches of the stage
				var matches = that.matchess.filter(function( match ){
					return ( match.stage==stage );
				});

				var count = 0;
				matches.forEach(function(match){
					// find the users bet					
					var bet = prono.filter(function( bet ){
						return ( bet.match_id==match.id );
					});
					bet = bet[0];
					
					if(typeof bet != 'undefined' && match.score1>-1 && match.score2 >-1 && bet.score1>-1 && bet.score2 >-1){
						if( (bet.score1==match.score1 && bet.score2==match.score2) ){
							count += 1;
						}
					}

				});
				return count;
			},
	
		});
	</script>

</dom-module>
