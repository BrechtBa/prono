
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>

		<api-model id="usersModel" token="[[token]]" url="../../api/index.php/user_profiles" model="{{usersModel}}" on-change="handleUsersModelChange"></api-model>
		<api-model id="rulesModel" token="[[token]]" url="../../api/index.php/rules" model="{{rulesModel}}" on-change="handleRulesModelChange"></api-model>
		
		<api-model id="teamsModel" token="[[token]]" url="../../api/index.php/teams" model="{{teamsModel}}" on-change="handleTeamsModelChange"></api-model>
		<api-model id="matchesModel" token="[[token]]" url="../../api/index.php/matches" model="{{matchesModel}}" on-change="handleMatchesModelChange"></api-model>

		<api-model id="pronoScoreModel" token="[[token]]" url="../../api/index.php/prono_score/user_id/{{tokenPayload.user_id}}" model="{{pronoScoreModel}}" on-change="handlePronoScoreModelChange"></api-model>
		<api-model id="pronoTeamModel" token="[[token]]" url="../../api/index.php/prono_team/user_id/{{tokenPayload.user_id}}" model="{{pronoTeamModel}}" on-change="handlePronoTeamModelChange"></api-model>
		<api-model id="pronoStageModel" token="[[token]]" url="../../api/index.php/prono_stage/user_id/{{tokenPayload.user_id}}" model="{{pronoStageModel}}" on-change="handlePronoStageModelChange"></api-model>
		<api-model id="pronoNumberModel" token="[[token]]" url="../../api/index.php/prono_number/user_id/{{tokenPayload.user_id}}" model="{{pronoNumberModel}}" on-change="handlePronoNumberModelChange"></api-model>
	
		<api-model id="allPronoScoreModel" token="[[token]]" url="../../api/index.php/prono_score/" model="{{allPronoScoreModel}}" on-change="handleAllPronoScoreModelChange"></api-model>
		<api-model id="allPronoTeamModel" token="[[token]]" url="../../api/index.php/prono_team/" model="{{allPronoTeamModel}}" on-change="handleAllPronoTeamModelChange"></api-model>
		<api-model id="allPronoStageModel" token="[[token]]" url="../../api/index.php/prono_stage/" model="{{allPronoStageModel}}" on-change="handleAllPronoStageModelChange"></api-model>
		<api-model id="allPronoNumberModel" token="[[token]]" url="../../api/index.php/prono_number/" model="{{allPronoNumberModel}}" on-change="handleAllPronoNumberModelChange"></api-model>

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
				},
				rulesModel: {
					type: 'Array',
					notify: true
				},
				usersModel: {
					type: 'Array',
					notify: true
				},
				teamsModel: {
					type: 'Array',
					notify: true
				},
				matchesModel: {
					type: 'Array',
					notify: true
				},
				pronoScoreModel: {
					type: 'Array',
					notify: true
				},
				pronoTeamModel: {
					type: 'Array',
					notify: true
				},
				allPronoScoreModel: {
					type: 'Array',
					notify: false
				},
				groups: {
					type: 'Array',
					notify: true
				},
				stages: {
					type: 'Array',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true,
					value: {}
				},
			},
			listeners: {
			},
			observers: [
				'tokenChanged(token)',
			],
			ready: function(){
				var that = this;
				document.addEventListener('prono-knockoutstage-teams-points-changed', function (e,d) {
					console.log(e.detail);
					that.pronoKnockoutstageTeamsPoints = e.detail;
				});
				document.addEventListener('prono-groupstage-points-changed', function (e,d) {
					console.log(e.detail);
					that.pronoGroupstagePoints = e.detail;
				});
			},
			tokenChanged: function(){
				console.log('token changed');
				this.$.usersModel.get();
			},
			handleUsersModelChange: function(e){
				console.log('check user profile');
				var done = true;
				try{
					var that = this;
					
					if( typeof that.tokenPayload.user_id != 'undefined' ){
						var user = that.usersModel.filter(function( item ) {
							return item.user_id == that.tokenPayload.user_id;
						});
						if(user.length > 0){
							that.user = user[0];
						}
						else{
							done = false;
							console.log('create user profile');
							// the user has no profile, it must be created
							that.$.usersModel.post({'user_id': this.tokenPayload.user_id, 'name': this.tokenPayload.login, 'avatar': ''});
						}
					}
					else{
						this.user = {};
					}
				}
				catch(e){
					this.user = {};
				}
			
				// proceed to the next step
				if(done){
					this.$.rulesModel.get();
				}
			},
			handleRulesModelChange: function(){
				console.log('get teams model');
				this.$.teamsModel.get();
			},
			handleTeamsModelChange: function(){
				console.log('get matches model');
				this.$.matchesModel.get();
			},
			handleMatchesModelChange: function(){
				console.log('get groups');
				var groups = [];
				this.matchesModel.forEach(function(match){
					if(match.stage == 0 && groups.indexOf(match.grp)==-1){
						groups.push(match.grp);
					}
				});
				this.groups = groups;
				
				console.log('get stages');
				var stages = [];
				this.matchesModel.forEach(function(match){
					if(match.stage > 0 && stages.indexOf(match.stage)==-1){
						stages.push(match.stage);
					}
				});
				this.stages = stages;
				
				this.fire('prono-model-changed')
				//this.$.pronoScoreModel.get();
			},
/*
			handlePronoScoreModelChange: function(){
				var done = true;
				console.log('check prono score');
				try{
					var that = this;
					this.matchesModel.every(function(match){
				
						// check if the match_id is in pronoScore
						var found = false;
						that.pronoScoreModel.forEach(function(prono){
							if(prono.match_id == match.id){
								found = true;
							}
						});

						if(!found ){
							done = false;
							// the match has no prono, it must be created
							console.log('adding prono score '+match.id);
							that.$.pronoScoreModel.post({'user_id':that.tokenPayload.user_id,'match_id':match.id,'score1':-1,'score2':-1,'penalty1':-1,'penalty2':-1});
						}
						return found;
					});
				}
				catch(e){
				}
				
				// proceed to the next step
				if(done){
					this.$.pronoTeamModel.get();
				}
			},
			handlePronoTeamModelChange: function(){
				var done = true;
				console.log('check prono team');
				try{
					var that = this;
					// check which prono's should be present
					var pronos = [];
					// group winner and runner up
					this.groups.forEach(function(group){
						pronos.push(group + '1');
						pronos.push(group + '2');
					});
					// knockoutstage teams
					this.stages.forEach(function(stage){
						for(var i=1; i<=stage; i++){
							pronos.push('stage' + stage + '_'+ i);
						}
					});
					
					pronos.every(function(prono){
						// check if the prono is in pronoTeam
						var found = false;
						that.pronoTeamModel.forEach(function(tempprono){
							if(tempprono.prono == prono){
								found = true;
							}
						});

						if(!found){
							done = false;
							// post the prono
							console.log('adding prono team '+prono);
							that.$.pronoTeamModel.post({'user_id':that.tokenPayload.user_id,'prono':prono,'team_id':-1});
						}
						return found;
					});
				}
				catch(e){
				}
			
				// proceed to the next step
				if(done){
					this.$.pronoStageModel.get();
				}
			},
*/

			calculatePoints: function(){
/*				var that = this;
				console.log('calculate points')

				that.usersModel.forEach(function(user){
					var points = 0;

					// get the users score prono
					var prono = that.allPronoScoreModel.filter(function( prono ){
						return ( prono.user_id==user.id );
					});
					
					points += that.countCorrectResults(prono,0)*3;//*that.rules[0]['groupstage_result'];	
					points += that.countCorrectResults(prono,16)*6;//*that.rules[0]['knockoutstage_result'];	
					points += that.countCorrectResults(prono,8)*6;//*that.rules[0]['knockoutstage_result'];	
					points += that.countCorrectResults(prono,4)*6;//*that.rules[0]['knockoutstage_result'];	
					points += that.countCorrectResults(prono,2)*6;//*that.rules[0]['knockoutstage_result'];	

					points += that.countCorrectScores(prono,0)*4;//*that.rules[0]['groupstage_score'];	
					points += that.countCorrectScores(prono,16)*8;//*that.rules[0]['knockoutstage_score'];	
					points += that.countCorrectScores(prono,8)*8;//*that.rules[0]['knockoutstage_score'];	
					points += that.countCorrectScores(prono,4)*8;//*that.rules[0]['knockoutstage_score'];	
					points += that.countCorrectScores(prono,2)*8;//*that.rules[0]['knockoutstage_score'];	
		

					if(user.points != points){
						// write points to database
						that.$.usersModel.put('user_id/'+user.id,{'points':points});
					}
				});*/
			},
	
		});
	</script>

</dom-module>
