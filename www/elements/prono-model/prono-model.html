
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>

		<api-model id="teamsModel" token="[[token]]" url="../../api/index.php/teams" model="{{teamsModel}}"></api-model>
		<api-model id="matchesModel" token="[[token]]" url="../../api/index.php/matches" model="{{matchesModel}}"></api-model>

		<api-model id="rulesModel" token="[[token]]" url="../../api/index.php/rules" model="{{rulesModel}}"></api-model>
		<api-model id="usersModel" token="[[token]]" url="../../api/index.php/user_profiles" model="{{usersModel}}" on-change="checkUserProfile"></api-model>

		<api-model id="pronoScoreModel" token="[[token]]" url="../../api/index.php/prono_score/user_id/{{user.id}}" model="{{pronoScoreModel}}" on-change="checkPronoScore"></api-model>
		<api-model id="pronoTeamModel" token="[[token]]" url="../../api/index.php/prono_team/user_id/{{user.id}}" model="{{pronoTeamModel}}" on-change="checkPronoTeam"></api-model>
		<api-model id="pronoStageModel" token="[[token]]" url="../../api/index.php/prono_stage/user_id/{{tokenPayload.user_id}}" model="{{pronoStageModel}}"></api-model>
		<api-model id="pronoNumberModel" token="[[token]]" url="../../api/index.php/prono_number/user_id/{{tokenPayload.user_id}}" model="{{pronoNumberModel}}"></api-model>
	
		<api-model id="allPronoScoreModel" token="[[token]]" url="../../api/index.php/prono_score/" model="{{allPronoScoreModel}}"></api-model>	
		<api-model id="allPronoTeamModel" token="[[token]]" url="../../api/index.php/prono_team/" model="{{allPronoTeamModel}}"></api-model>	

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
					observer: 'tokenChanged'
				},
				rulesModel: {
					type: 'Array',
					notify: true
				},
				usersModel: {
					type: 'Array',
					notify: true
				},
				teamsModel: {
					type: 'Array',
					notify: true
				},
				matchesModel: {
					type: 'Array',
					notify: true
				},
				pronoScoreModel: {
					type: 'Array',
					notify: true
				},
				pronoTeamModel: {
					type: 'Array',
					notify: true
				},
				allPronoScoreModel: {
					type: 'Array',
					notify: false
				},
				groups: {
					type: 'Array',
					notify: true
				},
				stages: {
					type: 'Array',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true,
					value: {}
				},
			},
			listeners: {
			},
			observers: [
				'getGroups(matchesModel)',
				'getStages(matchesModel)',
				'getPronoScore(user,matchesModel)',
				'getPronoTeam(user,groups,stages)',
				'calculatePoints(usersModel,matchesModel,allPronoScoreModel)',
			],
			tokenChanged: function(){
				try{
					console.log('loading models');
					this.$.rulesModel.get();
					this.$.usersModel.get();
					this.$.teamsModel.get();
					this.$.matchesModel.get();

					if(this.tokenPayload.permission > 5){
						console.log('loading confidential models');
						this.$.allPronoScoreModel.get();
					}
				}
				catch(e){

				}
			},
			getGroups: function(matchesModel){
				console.log('get groups');
				var groups = [];
				this.matchesModel.forEach(function(match){
					if(match.stage == 0 && groups.indexOf(match.grp)==-1){
						groups.push(match.grp);
					}
				});
				this.groups = groups;
			},
			getStages: function(matchesModel){
				var stages = [];
				this.matchesModel.forEach(function(match){
					if(match.stage > 0 && stages.indexOf(match.stage)==-1){
						stages.push(match.stage);
					}
				});
				this.stages = stages;
			},
			getPronoScore: function(user,matchesModel){
				if( typeof user.id != 'undefined' && matchesModel.length > 0 ){
					this.$.pronoScoreModel.get();
				}
			},
			getPronoTeam: function(user,groups,stages){
				if( typeof user.id != 'undefined' && groups.length > 0 && stages.length > 0){
					this.$.pronoTeamModel.get();
				}
			},
			getPronoStage: function(user,stages){
				this.$.pronoStageModel.get();
			},
			getPronoNumber: function(user){
				this.$.pronoNumberModel.get();
			},
			checkUserProfile: function(){
				console.log('check user profile');
				try{
					var that = this;
					
					if( typeof that.tokenPayload.user_id != 'undefined' ){
						var user = that.usersModel.filter(function( item ) {
							return item.user_id == that.tokenPayload.user_id;
						});
						if(user.length > 0){
							this.user = user[0];
						}
						else{
							console.log('create user profile');
							// the user has no profile, it must be created
							that.$.usersModel.post({'user_id': this.tokenPayload.user_id, 'name': this.tokenPayload.login, 'avatar': ''});
						}
					}
					else{
						this.user = {};
					}
				}
				catch(e){
					this.user = {};
				}
			},
			checkPronoScore: function(){
				console.log('check prono score');
				try{
					var that = this;
					this.matchesModel.every(function(match){
				
						// check if the match_id is in pronoScore
						var found = false;
						that.pronoScoreModel.forEach(function(prono){
							if(prono.match_id == match.id){
								found = true;
							}
						});

						if(!found ){
							console.log(that.pronoScoreModel);
							// the match has no prono, it must be created
							console.log('adding prono score '+match.id);
							that.$.pronoScoreModel.post({'user_id':that.tokenPayload.user_id,'match_id':match.id,'score1':-1,'score2':-1,'penalty1':-1,'penalty2':-1});
						}
						return found;
					});
				}
				catch(e){
				}
			},
			checkPronoTeam: function(){
				console.log('check prono team');
				try{
					var that = this;
					// check which prono's should be present
					var pronos = [];
					// group winner and runner up
					this.groups.forEach(function(group){
						pronos.push(group + '1');
						pronos.push(group + '2');
					});
					// knockoutstage teams
					this.stages.forEach(function(stage){
						for(var i=1; i<=stage; i++){
							pronos.push('stage' + stage + '_'+ i);
						}
					});
					
					pronos.every(function(prono){
						// check if the prono is in pronoTeam
						var found = false;
						that.pronoTeamModel.forEach(function(tempprono){
							if(tempprono.prono == prono){
								found = true;
							}
						});

						if(!found){
							// post the prono
							console.log('adding prono team '+prono);
							that.$.pronoTeamModel.post({'user_id':that.tokenPayload.user_id,'prono':prono,'team_id':-1});
						}
						return found;
					});
				}
				catch(e){
				}
			},
			calculatePoints: function(usersModel,matchesModel,allPronoScoreModel){
				if(this.tokenPayload.permission>5 && usersModel.length>0 && matchesModel.length>0 && allPronoScoreModel.length>0){

					var that = this;
					console.log('calculate points')

					that.usersModel.forEach(function(user){
						var points = 0;

						// get the users score prono
						var prono = that.allPronoScoreModel.filter(function( prono ){
							return ( prono.user_id==user.id );
						});
						
						points += that.countCorrectResults(prono,0)*3;//*that.rules[0]['groupstage_result'];	
						points += that.countCorrectResults(prono,16)*6;//*that.rules[0]['knockoutstage_result'];	
						points += that.countCorrectResults(prono,8)*6;//*that.rules[0]['knockoutstage_result'];	
						points += that.countCorrectResults(prono,4)*6;//*that.rules[0]['knockoutstage_result'];	
						points += that.countCorrectResults(prono,2)*6;//*that.rules[0]['knockoutstage_result'];	

						points += that.countCorrectScores(prono,0)*4;//*that.rules[0]['groupstage_score'];	
						points += that.countCorrectScores(prono,16)*8;//*that.rules[0]['knockoutstage_score'];	
						points += that.countCorrectScores(prono,8)*8;//*that.rules[0]['knockoutstage_score'];	
						points += that.countCorrectScores(prono,4)*8;//*that.rules[0]['knockoutstage_score'];	
						points += that.countCorrectScores(prono,2)*8;//*that.rules[0]['knockoutstage_score'];	
			

						if(user.points != points){
							// write points to database
							that.$.usersModel.put('user_id/'+user.id,{'points':points});
						}
					});
					
				}
			},
			countCorrectResults(prono,stage){
				var that = this;
				
				// get the matches of the stage
				var matches = that.matchesModel.filter(function( match ){
					return ( match.stage==stage );
				});

				var count = 0;
				matches.forEach(function(match){
					// find the users bet					
					var bet = prono.filter(function( bet ){
						return ( bet.match_id==match.id );
					});
					bet = bet[0];

					if(typeof bet != 'undefined' && match.score1>-1 && match.score2 >-1 && bet.score1>-1 && bet.score2 >-1){
						if( (bet.score1>bet.score2 && match.score1>match.score2) || (bet.score1<bet.score2 && match.score1<match.score2) || (bet.score1==bet.score2 && match.score1==match.score2) ){
							count += 1;
						}
					}

				});
				return count;
			},
			countCorrectScores(prono,stage){
				var that = this;
				
				// get the matches of the stage
				var matches = that.matchesModel.filter(function( match ){
					return ( match.stage==stage );
				});

				var count = 0;
				matches.forEach(function(match){
					// find the users bet					
					var bet = prono.filter(function( bet ){
						return ( bet.match_id==match.id );
					});
					bet = bet[0];
					
					if(typeof bet != 'undefined' && match.score1>-1 && match.score2 >-1 && bet.score1>-1 && bet.score2 >-1){
						if( (bet.score1==match.score1 && bet.score2==match.score2) ){
							count += 1;
						}
					}

				});
				return count;
			},
	
		});
	</script>

</dom-module>
