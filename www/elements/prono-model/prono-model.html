
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>

		<api-model id="usersModel" token="[[token]]" url="../../api/index.php/user_profiles" model="{{usersModel}}" on-change="handleUsersModelChange"></api-model>
		<api-model id="rulesModel" token="[[token]]" url="../../api/index.php/rules" model="{{rulesModel}}" on-change="handleRulesModelChange"></api-model>
		
		<api-model id="teamsModel" token="[[token]]" url="../../api/index.php/teams" model="{{teamsModel}}" on-change="handleTeamsModelChange"></api-model>
		<api-model id="matchesModel" token="[[token]]" url="../../api/index.php/matches" model="{{matchesModel}}" on-change="handleMatchesModelChange"></api-model>

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
				},
				rulesModel: {
					type: 'Array',
					notify: true
				},
				usersModel: {
					type: 'Array',
					notify: true
				},
				teamsModel: {
					type: 'Array',
					notify: true
				},
				matchesModel: {
					type: 'Array',
					notify: true
				},
				pronoScoreModel: {
					type: 'Array',
					notify: true
				},
				pronoTeamModel: {
					type: 'Array',
					notify: true
				},
				allPronoScoreModel: {
					type: 'Array',
					notify: false
				},
				groups: {
					type: 'Array',
					notify: true
				},
				stages: {
					type: 'Array',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true,
					value: {}
				}
			},
			listeners: {
			},
			observers: [
				'tokenChanged(token)',
			],
			ready: function(){
				var that = this;
				document.addEventListener('prono-groupstage-points-changed', function(e){
					that.pronoGroupstagePoints = e.detail;
					that.calculatePoints();
				});
				document.addEventListener('prono-groupstage-winners-points-changed', function(e){
					that.pronoGroupstageWinnersPoints = e.detail;
					that.calculatePoints();
				});
				document.addEventListener('prono-knockoutstage-points-changed', function(e){
					that.pronoKnockoutstagePoints = e.detail;
					that.calculatePoints();
				});
				document.addEventListener('prono-knockoutstage-teams-points-changed', function(e){
					that.pronoKnockoutstageTeamsPoints = e.detail;
					that.calculatePoints();
				});
			},
			tokenChanged: function(){
				console.log('token changed');				
				this.$.usersModel.get();
			},
			handleUsersModelChange: function(e){
				console.log('check user profile');
				var done = true;
				try{
					var that = this;
					
					if( typeof that.tokenPayload.user_id != 'undefined' ){
						var user = that.usersModel.filter(function( item ) {
							return item.user_id == that.tokenPayload.user_id;
						});
						if(user.length > 0){
							that.user = user[0];
						}
						else{
							done = false;
							console.log('create user profile');
							// the user has no profile, it must be created
							that.$.usersModel.post({'user_id': this.tokenPayload.user_id, 'name': this.tokenPayload.login, 'avatar': ''});
						}
					}
					else{
						this.user = {};
					}
				}
				catch(e){
					this.user = {};
				}
			
				// proceed to the next step
				if(done){
					this.$.rulesModel.get();
				}
			},
			handleRulesModelChange: function(){
				console.log('get teams model');
				this.$.teamsModel.get();
			},
			handleTeamsModelChange: function(){
				console.log('get matches model');
				this.$.matchesModel.get();
			},
			handleMatchesModelChange: function(){
				console.log('get groups');
				var groups = [];
				this.matchesModel.forEach(function(match){
					if(match.stage == 0 && groups.indexOf(match.grp)==-1){
						groups.push(match.grp);
					}
				});
				this.groups = groups;
				
				console.log('get stages');
				var stages = [];
				this.matchesModel.forEach(function(match){
					if(match.stage > 0 && stages.indexOf(match.stage)==-1){
						stages.push(match.stage);
					}
				});
				this.stages = stages;
				this.fire('prono-model-changed')
			},
			calculatePoints: function(){
				var that = this;
				console.log('calculate points')
				that.usersModel.forEach(function(user){
					// check if all points are defined
					if( typeof that.pronoGroupstagePoints != 'undefined'
					 &&	typeof that.pronoGroupstageWinnersPoints != 'undefined'
					 &&	typeof that.pronoKnockoutstageTeamsPoints != 'undefined'
					 &&	typeof that.pronoKnockoutstagePoints != 'undefined'

					 && typeof that.pronoGroupstagePoints[user.id] != 'undefined'
					 &&	typeof that.pronoGroupstageWinnersPoints[user.id] != 'undefined'
					 &&	typeof that.pronoKnockoutstageTeamsPoints[user.id] != 'undefined'
					 &&	typeof that.pronoKnockoutstagePoints[user.id] != 'undefined' ){

						//add all points
						var points = that.pronoGroupstagePoints[user.id]
							       + that.pronoGroupstageWinnersPoints[user.id]
								   + that.pronoKnockoutstageTeamsPoints[user.id]
								   + that.pronoKnockoutstagePoints[user.id];


						if(user.points != points){
							// write points to database
							that.$.usersModel.put('user_id/'+user.id,{'points':points});
						}
					}
				});
			}
	
		});
	</script>

</dom-module>
