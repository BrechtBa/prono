
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/prono-score-dialog/prono-score-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module id="prono-groupwinners">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.teamicon{
				width: 30px;
				height: 30px;
			}
			.teamname{
				padding-left: 20px;
			}
			.hidden{
				display: none;
			}
		</style>

		<div on-tap="editWinners">
			<div class="horizontal layout center">
				<div class="flex">Winner:</div>
				<prono-team-icon class="teamicon" team="{{getWinner(group,teamsModel,pronoTeamModel)}}"></prono-team-icon>
				<prono-team-name class="flex-2 teamname" team="{{getWinner(group,teamsModel,pronoTeamModel)}}" default=""></prono-team-name>
			</div>
			<div class="horizontal layout center">
				<div class="flex">Runner up:</div>
				<prono-team-icon class="teamicon" team="{{getRunnerup(group,teamsModel,pronoTeamModel)}}"></prono-team-icon>
				<prono-team-name class="flex-2 teamname" team="{{getRunnerup(group,teamsModel,pronoTeamModel)}}" default=""></prono-team-name>
			</div>
		</div>

		<default-dialog id="editWinners">
			<form is="iron-form" id="form" method="post" on-iron-form-submit="save" action="/">
				<div>
					<paper-dropdown-menu label="Winner">
						<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{winner}}">
							<paper-item value="0"></paper-item>
							<template is="dom-repeat" items="{{teamsModel}}" as="team" filter="{{filterGroupTeams(group,matchesModel)}}">
								<paper-item value="{{team.id}}">{{team.name}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>

					<paper-dropdown-menu label="Runner up">
						<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{runnerup}}">
							<paper-item value="0"></paper-item>
							<template is="dom-repeat" items="{{teamsModel}}" as="team" filter="{{filterGroupTeams(group,matchesModel)}}">
								<paper-item value="{{team.id}}">{{team.name}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>
				</div>
				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmit">Save</paper-button>
					<button type="submit" class="hidden">Save</button>
				</div>
			</form>
		</default-dialog>

	</template>

	<script>
		Polymer({
			is: 'prono-groupwinners',
			properties: {
				token: {
					type: 'String',
					value: ''
				},
				teamsModel: {
					type: 'Array',
				},
				matchesModel: {
					type: 'Array',
				},
				pronoTeamModel: {
					type: 'Array'
				},
				group: {
					type: 'String'
				}
			},
			ready: function(){
			},
			editWinners: function(){
				winner = this.getWinner(this.group,this.teamsModel,this.pronoTeamModel);
				if( winner != {} ){
					this.winner = winner.id;
				}

				runnerup = this.getRunnerup(this.group,this.teamsModel,this.pronoTeamModel);
				if( runnerup != {} ){
					this.runnerup = runnerup.id;
				}

				this.$.editWinners.open();
			},
			filterGroupTeams: function(group,matchesModel){
				// find the matches in the group
				try{			
					var matches = matchesModel.filter(function( match ){
						return ( match.grp == group );
					});
				}
				catch(e){
					var matches = [];
				}
				var team_ids = [];
				matches.forEach(function(match){
					if(team_ids.indexOf(match.team1) == -1){
						team_ids.push( match.team1 );
					}
					if(team_ids.indexOf(match.team2) == -1){
						team_ids.push( match.team2 );
					}
				});

				return function(item){
					return ( team_ids.indexOf(item.id) > -1 );
			  	};
			},
			getWinner: function(group,teamsModel,pronoTeamModel){
				var team = {};
				var id = -1;
				try{
					pronoTeamModel.forEach(function(item){
						if(item.prono == group + '1'){					
							id = item.team_id;
						}
					});

					teamsModel.forEach(function(item){
						if(item.id == id){					
							team = item;
						}
					});
				}
				catch(e){
				}
				return team;
			},
			getRunnerup: function(group,teamsModel,pronoTeamModel){
				var team = {};
				var id = -1;
				try{
					pronoTeamModel.forEach(function(item){
						if(item.prono == group + '2'){					
							id = item.team_id;
						}
					});

					teamsModel.forEach(function(item){
						if(item.id == id){					
							team = item;
						}
					});
				}
				catch(e){
				}
				return team;
			},
			formSubmit: function(){
				this.$.form.submit();
			},
			save: function(){
				this.$.editWinners.close();

				app.$.model.$.pronoTeamModel.put('prono/'+this.group+'1',{'team_id': this.winner});
				app.$.model.$.pronoTeamModel.put('prono/'+this.group+'2',{'team_id': this.runnerup});
			}
		});
	</script>

</dom-module>
