
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../elements/default-dialog/default-dialog.html">

<dom-module id="users-list">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-card{
      			margin-bottom: 5px;
				cursor: pointer;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
				width: 100%;
    		}
			.buttons{
				margin-top: 20px;
				text-align: right;
			}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.name{
				padding: 10px;
			}
			.hidden{
				display: none;
			}
			default-dialog .avatar{
				--size: 80px;
			}
		</style>

		<iron-ajax id="getUserProfiles" url="../../api/index.php/user_profiles" method="GET" handle-as="json" last-response="{{user_profiles}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="getUsers" url="../../api/index.php/users" method="GET" handle-as="json" last-response="{{users}}" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="putUser" method="PUT" handle-as="json" on-response="handlePutUserResponse" last-response="{{putUserResponse}}" debounce-duration="300"></iron-ajax>
		
		<iron-ajax id="deleteUser" method="DELETE" handle-as="json" on-response="handleDeleteUserResponse" last-response="{{deleteUserResponse}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="deleteUserProfile" method="DELETE" handle-as="json" on-response="handleDeleteUserProfileResponse" last-response="{{deleteUserProfileResponse}}" debounce-duration="300"></iron-ajax>


		<template is="dom-repeat" id="usersList" items="{{user_profiles}}" as="user">
			<paper-card elevation="2" on-tap="editUserDialog">
				<div class="horizontal layout center">
					<avatar-image class="avatar" user="{{user}}"></avatar-image>
					<div class="flex name">{{user.login}}</div>
					<div class="flex name">{{user.name}}</div>
				</div>
			</paper-card>
		</template>


		<default-dialog id="editUserDialog">
			<h2>{{user.login}}</h2>
			<form is="iron-form" id="editUserForm" method="post" on-iron-form-submit="saveUser" action="/">
				<paper-input id="permission" label="Permission:" value="{{user.permission}}" auto-validate pattern="[0-9]" error-message="0-9"></paper-input>
				<div class="buttons">
					<paper-button raised class="primary" on-tap="editUserFormSubmit">Save</paper-button>
				</div>
			</form>
			<div class="buttons">
				<paper-button raised on-tap="resetPassword">Reset password</paper-button>
				<paper-button raised on-tap="deleteUser">Delete</paper-button>
			</div>
				
		</default-dialog>

	</template>

	<script>
		Polymer({
			is: 'users-list',
			properties: {
				token: {
					type: 'String',
					value: '',
					notify: true,
					observer: 'tokenChanged'
				}
			},
			ready: function(){
			},
			closeDialog: function(){
				this.$.editUser.close();
			},
			tokenChanged: function(){
				if( this.token != ''){
					this.$.getUserProfiles.headers['Authentication'] = this.token;
					this.$.getUserProfiles.generateRequest();

					this.$.getUsers.headers['Authentication'] = this.token;
					this.$.getUsers.generateRequest();
				}
			},
			editUserDialog: function(e){
				this.user = e.model.__data__.user;
				that = this;
				var user = {};	
				that.users.forEach(function(item){
					if(item.id == that.user.user_id){
						user = item;
					}
				});

				this.set('user.permission',user.permission);
				this.$.editUserDialog.open();
			},
			editUserFormSubmit: function(){
				this.$.editUserForm.submit();
			},
			saveUser: function(event){
				this.$.putUser.url = 'api/index.php/users/'+this.user.user_id
				this.$.putUser.headers['Authentication'] = this.token;
				this.$.putUser.body = JSON.stringify({'permission':this.user.permission});
				this.$.putUser.generateRequest();
				this.$.editUserDialog.close();
			},
			handlePutUserResponse: function(event,request){
				var headers = request.xhr.getAllResponseHeaders();
				this.$.getUsers.headers['Authentication'] = this.token;
				this.$.getUsers.generateRequest();

				this.$.getUserProfiles.headers['Authentication'] = this.token;
				this.$.getUserProfiles.generateRequest();
			},
			deleteUser: function(){
				this.$.editUserDialog.close();

				this.$.deleteUser.headers['Authentication'] = this.token;
				this.$.deleteUser.url = 'api/index.php/users/'+this.user.user_id
				this.$.deleteUser.generateRequest();

				this.$.deleteUserProfile.headers['Authentication'] = this.token;
				this.$.deleteUserProfile.url = 'api/index.php/user_profiles/'+this.user.id
				this.$.deleteUserProfile.generateRequest();
				
			},
			handleDeleteUserResponse: function(event,request){
				var headers = request.xhr.getAllResponseHeaders();
				this.$.getUsers.headers['Authentication'] = this.token;
				this.$.getUsers.generateRequest();
			},
			handleDeleteUserProfileResponse: function(event,request){
				var headers = request.xhr.getAllResponseHeaders();
				this.$.getUserProfiles.headers['Authentication'] = this.token;
				this.$.getUserProfiles.generateRequest();
			},
			resetPassword: function(){
				console.log('Not implemented yet');
			}
		});
	</script>

</dom-module>
