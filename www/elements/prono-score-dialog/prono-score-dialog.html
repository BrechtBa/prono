<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/prono-dialog/prono-dialog.html">

<dom-module is="prono-score-dialog">
	<template>
		<style>
			:host{
			}
			.teamname{
				text-align: center;
				margin-top: 10px;
			}
			.score{
				text-align: center;
			}
			.dash{
				margin-top: 10px;
			}
			.teamicon{
				width: 45px;
				height: 45px;
				margin: 25px 10px 10px 10px;
			}
			.score paper-input{
				margin-top: -10px;
			}
			.hidden{
				display: none;
			}
		</style>
		
		<iron-ajax id="ajaxPut" method="PUT" handle-as="json" on-response="handleAjaxPutResponse" last-response="{{ajaxPutResponse}}" debounce-duration="300"></iron-ajax>

		<prono-dialog id="dialog">
			<form is="iron-form">
				<div class="vertical layout center-justified">
					<div class="teamname">{{formatTeamName(match.team1,teams)}}</div>
					<div class="horizontal layout center center-justified">
						<div>
							<img class="teamicon" src="{{formatTeamIcon(match.team1,teams)}}">
						</div>
					
						<div class="flex-2 score"><paper-input label="" auto-validate pattern="[0-9]*" error-message="not a valid score" value={{score1}}></paper-input></div>
						<div class="flex-1 score dash"> - </div>
						<div class="flex-2 score"><paper-input label="" auto-validate pattern="[0-9]*" error-message="not a valid score" value={{score2}}></paper-input></div>
					
						<div>
							<img class="teamicon" src="{{formatTeamIcon(match.team2,teams)}}">
						</div>
					</div>
					<div class="teamname">{{formatTeamName(match.team2,teams)}}</div>
				</div>
				<div class="buttons">
					<paper-button raised class="button-main" on-tap="save">Save</paper-button>
					<input type="submit" class="hidden">
				</div>
			</form>
		</prono-dialog>
			
	</template>
	<script>
		Polymer({
			is: 'prono-score-dialog',
			properties: {
				match: {
					type: 'Object'
				},
				score:  {
					type: 'Object'
				},
				teams: {
					type: 'Array'
				},
				user: {
					type: 'Number'
				},
				score1: {
					type: 'Number',
					computed: 'formatScore(score.score1)'
				},
				score2: {
					type: 'Number',
					computed: 'formatScore(score.score2)'
				},
			},
			close: function(){
				this.$.dialog.close();
			},
			open: function(){
				this.$.dialog.open();
			},
			save: function(){
				if(this.user==0){
					this.$.ajaxPut.url = 'api/index.php/matches/'+this.match.id;
				}
				else{
					this.$.ajaxPut.url = 'api/index.php/scorebets/match/'+this.match.id+'/user/'+this.user;
				}
				this.$.ajaxPut.headers['Authentication'] = this.token;

				var score1 = this.score1;
				if(score1 == ''){
					score1 = -1;
				}
				var score2 = this.score2;
				if(score2 == ''){
					score2 = -1;
				}

				this.$.ajaxPut.body = JSON.stringify({'score1':score1,'score2':score2});
				console.log(this.$.ajaxPut.url);
				console.log(this.$.ajaxPut.body);
				//this.$.ajaxPut.generateRequest();
	
			},
			formatTeamName: function(id,teams){
				var name = '';
				teams.forEach(function(item){
					if(item.id == id){
						name = item.name;
					}
				});
				return name;
			},
			formatTeamIcon: function(id,teams){
				var iso_icon='';
				var icon = '';
				teams.forEach(function(item){
					if(item.id == id){
						iso_icon = item.iso_icon;
						icon = item.icon;
					}
				});

				if(iso_icon != ''){
					return 'images/flags/'+iso_icon+'.png';
				}
				else{
					return icon;
				}
			},
			formatScore: function(score){
				if(score<0){
					return '';
				}
				else{
					return score;
				}
			},
		});
	</script>
</dom-module>
