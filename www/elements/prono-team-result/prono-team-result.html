
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/default-dialog/default-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module id="prono-team-result">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-material{
      			margin: 5px;
				cursor: pointer;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
				border-radius: 2px;
    		}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.disabled::after{
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(1,1,1,0.3);
				border-radius: 2px;
			}
			.hidden{
				display: none;
			}
			.team{
				width: 24%;
				min-width: 140px;
			}
			.teamicon{
				width: 90%;
				max-width: 30px;
				height: auto;
				margin-top: 1px;
				margin-bottom: 1px;
				margin-right: 5px;
			}
			.teamname{
				text-align: center;
				margin-top: 5px;
				margin-bottom: 5px;
			}
			.selected{
				background-color: #dddddd;
			}
		</style>

		<!--<api-model id="teamIds" token="{{token}}" url="../../api/index.php/prono_team_result_teams/" model="{{teamIds}}" on-change="handleTeamIdsChange"></api-model>-->

		<api-model id="prono" token="{{token}}" url="../../api/index.php/prono_team_result/user_id/{{user.id}}" model="{{prono}}" on-change="handlePronoChange"></api-model>
		<api-model id="allProno" token="{{token}}" url="../../api/index.php/prono_team_result/" model="{{allProno}}" on-change="handleAllPronoChange"></api-model>

		<template is="dom-if" if="{{isProno(user)}}">
			<paper-material class$="{{disabledClass(currentStage,user)}}" elevation="2">
				<h3>{{trans('Team result')}}:</h3>
				<template is="dom-repeat" items="{{getTeams(teamIds,teamsModel)}}" as="team" sort="_sortTeams">
					<div class="horizontal layout center wrap" on-tap="editResult">
						<div class="team horizontal layout center">
							<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
							<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
						</div>
						<div>
							<h3>{{getParsedResult(prono,team.id)}}</h3>
						</div>
					</div>
				</template>	
			</paper-material>
		</template>

		<!--<template is="dom-if" if="{{!isProno(user)}}">
			<paper-material class="horizontal layout" elevation="2" on-tap="editTeams">
				<div class="horizontal layout center-justified wrap">
					<template is="dom-repeat" items="{{getTeams(teamIds,teamsModel)}}" as="team" sort="_sortTeams">
						<div class="team horizontal layout center">
							<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
							<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
						</div>
					</template>
				</div>
			</paper-material>
		</template>-->




		<default-dialog id="editResult">
			<form is="iron-form" id="formProno" method="post" on-iron-form-submit="saveProno" action="/">
				<div class="horizontal layout center">
					<prono-team-icon class="teamicon" team="{{editTeam}}"></prono-team-icon>
					<prono-team-name class="teamname" team="{{editTeam}}"></prono-team-name>
				</div>
				<paper-dropdown-menu label="{{trans('Result')}}">
					<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{result}}">
						<paper-item value="-1"></paper-item>
						<template is="dom-repeat" items="{{getStages(matchesModel)}}" as="stage">
							<paper-item value="{{stage}}">{{parseResult(stage)}}</paper-item>
						</template>
					</paper-menu>
				</paper-dropdown-menu>


				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmitProno">{{trans('Save')}}</paper-button>
					<button type="submit" class="hidden">{{trans('Save')}}</button>
				</div>
			</form>
		</default-dialog>


		<!--<default-dialog id="editTeams">
			<form is="iron-form" id="formConfig" method="post" on-iron-form-submit="saveConfig" action="/">
				<template is="dom-repeat" items="{{teamsModel}}" as="team">
	        		<div class$="horizontal layout center {{selectedClass(team,teamIds)}}" on-tap="selectTeam">
						<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
						<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
					</div>
				</template>

				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmitConfig">Save</paper-button>
					<button type="submit" style="display:none;">Save</button>
				</div>
			</form>
		</default-dialog>-->


	</template>

	<script>
		Polymer({
			is: 'prono-team-result',
			properties: {
				token: {
					type: 'String',
					value: ''
				},
				permission: {
					type: 'Number',
					value: 1
				},
				currentStage:{
					type: 'Number',
					value: -1
				},
				teamsModel: {
					type: 'Array',
				},
				matchesModel: {
					type: 'Array',
				},
				user: {
					type: 'Object',
					value: {}
				}
			},
			created: function(){
				// create the local dictionary
				this.dictionary = {};
				this.dictionary['Team result'] 						= {'nl':'Ploeg resultaat'};
				this.dictionary['Result'] 							= {'nl':'Resultaat'};
				this.dictionary['eliminated in the groupstage'] 	= {'nl':'geëlimineerd in de groepsfase'};
				this.dictionary['eliminated in the round of '] 		= {'nl':'geëlimineerd in de round of '};
				this.dictionary['eliminated in the round of 16'] 	= {'nl':'geëlimineerd in de 8e finale'};
				this.dictionary['eliminated in the quarter-finals'] = {'nl':'geëlimineerd in de kwartfinale'};
				this.dictionary['eliminated in the semi-finals'] 	= {'nl':'geëlimineerd in de halve finale'};
				this.dictionary['eliminated in the final'] 			= {'nl':'geëlimineerd in de finale'};
				this.dictionary['winner'] 							= {'nl':'winnaar'};
			},
			ready: function(){
				console.log('ready');
				
				// add global event listeners
				var that = this;
				/*that.$.teamIds.get();*/
				// for now define the teams on which to bet static
				that.teamIds = [3];


				document.addEventListener('prono-model-changed', function(e){
					that.$.prono.get();
				});
				document.addEventListener('calculate-user-points', function(e){
					var user_id = e.detail;
					that.calculateUserPoints(user_id);
				});
			},
			isProno: function(user){
				return (typeof user.id != 'undefined');
			},
			disabledClass: function(currentStage,user){
				if( 0 == currentStage || typeof user.id == 'undefined'){
					return '';
				}
				else{
					return 'disabled';
				}
			},
			getTeam: function(id,teamsModel){
				var team = {};
				teamsModel.forEach(function(item){
					if(item.id == id){					
						team = item;
					}
				});
				return team;
			},
			getTeams: function(ids,teamsModel){
				var teams = [];
				var that = this;
				ids.forEach(function(id){
					teams.push(that.getTeam(id,teamsModel))
				});
				return teams;
			},
			getStages: function(matchesModel){
				var tempstages = []
				var stages = []

				matchesModel.forEach(function(item){
					if(item.stage>0 && tempstages.indexOf(item.stage)<0 && item.stage>0){
						tempstages.push(item.stage);
					}
				});

				// sort tempstages
				tempstages.sort(function(a, b){return a-b}).reverse();
				if(tempstages.indexOf(this.currentStage)<0){
					this.expandedStage = tempstages[0];
				}
				else{
					this.expandedStage = this.currentStage;
				}

				// groupstage
				stages.push("0");

				// knockout stage
				tempstages.forEach(function(stage){
					var tempmatches = [];
					matchesModel.forEach(function(match){
						if(match.stage == stage && match.position < stage/4+1){
							tempmatches.push(match);
						}
					});

					stages.push(stage);
				});

				// winner
				stages.push("1");

				return stages;
			},
			getResult: function(prono,teamId){
				var tempresult = -1;
				prono.every(function(tempprono){
					if(tempprono.team_id==teamId){
						tempresult = tempprono.result;
						return true;
					}
					return false;
				});
				return tempresult;
			},
			getParsedResult: function(prono,teamId){
				return this.parseResult(this.getResult(prono,teamId));
			},
			parseResult: function(result){
				var description = '';
				if(result === "0"){
					description = this.trans('eliminated in the groupstage');
				}
				else if(result-0 > 16){
					description = this.trans('eliminated in the round of ')+result;
				}
				else if(result === "16"){
					description = this.trans('eliminated in the round of 16');
				}
				else if(result === "8"){
					description = this.trans('eliminated in the quarter-finals');
				}
				else if(result === "4"){
					description = this.trans('eliminated in the semi-finals');
				}
				else if(result === "2"){
					description = this.trans('eliminated in the final');
				}
				else if(result === "1"){
					description = this.trans('winner');
				}
				return description;
			},
			editResult: function(e){
				this.editTeam = e.model.__data__.team;

				var result = this.getResult(this.prono,this.editTeam.id);
				this.result = result;

				this.$.editResult.open();
			},
			formSubmitProno: function(){
				this.$.formProno.submit();
			},
			saveProno: function(){
				this.$.editResult.close();

				this.$.prono.put('team_id/'+this.editTeam.id,{'result': this.result});
			},
			/*formSubmitConfig: function(){
				this.$.formConfig.submit();
			},
			saveConfig: function(){
				this.$.editTeams.close();

				var that = this;
				var teams = this.teamsModel.filter(function(team){
					return (that.selectedTeams.indexOf(team.id)>-1);
				});			
				teams.sort(this._sortTeams);

				for(var i=1; i<=this.editStage; i++){
					if(typeof teams[i-1] != 'undefined'){
						this.$.teamIds.put('prono_id/stage' + this.editStage + '_' + i,{'team_id':teams[i-1].id});
					}
					else{
						this.$.teamIds.put('prono_id/stage' + this.editStage + '_' + i,{'team_id':-1});
					}
				}
			},*/

			handlePronoChange: function(){
				var done = true;
				console.log('check prono team result');
				try{
					if(typeof this.user.id != 'undefined'){
						var that = this;
						pronos = that.teamIds;
						pronos.every(function(prono){
							// check if the prono is in the database
							var found = false;
							that.prono.forEach(function(tempprono){
								if(tempprono.team_id == prono){
									found = true;
								}
							});

							if(!found){
								done = false;
								// post the prono
								console.log('adding prono team result ' + prono);
								that.$.prono.post({'user_id':that.user.id,'team_id':prono,'result':-1});
							}
							return found;
						});
					}
					else{
						this.prono = [];
					}
				}
				catch(e){
				}
				
				// proceed to the next step
				if(done){
					this.$.allProno.get();
				}
			},
			handleAllPronoChange: function(){
				if(this.permission > 5){
					var that = this;
					var points = {};
					this.allProno.forEach(function(prono){
						if( !(prono.user_id in points) ){
							points[prono.user_id] = 0;
						}
						points[prono.user_id] += that.calculatePronoPoints(prono);
						
					});
					this.fire('prono-team-result-points-changed',points);
				}
			},
			calculateUserPoints: function(user_id){
				if(typeof this.user.id != 'undefined'){
					var that = this;
					var points = 0;
					if(user_id == this.user.id){
						var prono = this.prono;
					}
					else if(this.permission > 8){
						var prono = this.allProno.filter(function(prono){
							return (prono.user_id == user_id);
						});
					}
					prono.forEach(function(prono){
						points += that.calculatePronoPoints(prono);
					});
					this.fire('user-points',{'prono':'prono-team-result', 'points':points});
				}
			},
			calculatePronoPoints: function(prono){
				var that = this;

				// find the actual result of the team
				var stages = this.getStages(this.matchesModel)
				stages.pop(); // remove final element

				var teaminstage = [];

				var that = this;
				stages.forEach(function(stage){
					var matches = that.matchesModel.filter(function(tempmatch){
						return tempmatch.stage==stage
					});
					
					var tempteaminstage = 0;
					matches.forEach(function(tempmatch){
						if(tempmatch.team1 == prono.team_id || tempmatch.team2 == prono.team_id){
							tempteaminstage = 1;
						}
						if(tempmatch.team1 <= 0 || tempmatch.team2 <= 0){
							tempteaminstage = -1;  // teams not known yet
						}
					});
					teaminstage.push(tempteaminstage);
				});

				var result = -1;
				for(var i=0;i<teaminstage.length;i++){
					if(teaminstage[i] == 1 && teaminstage[i+1] == 0){
						result = stages[i];
						break;
					}
				}

				// final or winner, check the score
				if(result == -1 && teaminstage[teaminstage.length-1] == 1){
					var matches = this.matchesModel.filter(function(tempmatch){
						return tempmatch.stage==2
					});
					var finalmatch = matches[0];

					
					if(prono.team_id==finalmatch.team1){
						if(finalmatch.score1>-1 && finalmatch.score2>-1){
							if(finalmatch.score1 + 0.1*finalmatch.penalty1 > finalmatch.score2 + 0.1*finalmatch.penalty2){
								result = 1;
							}
							else{
								result = 2;
							}
						}
					}
					else if(prono.team_id==finalmatch.team2){
						if(finalmatch.score1>-1 && finalmatch.score2>-1){
							if(finalmatch.score1 + 0.1*finalmatch.penalty1 > finalmatch.score2 + 0.1*finalmatch.penalty2){
								result = 2;
							}
							else{
								result = 1;
							}
						}
					}
				}

				// calculate the points
				var points = 0;
				if(prono.result>-1 && prono.result == result){
					if(result == 0){
						points = 10;
					}
					else if(result == 16){
						points = 15;
					}
					else if(result == 8){
						points = 20;
					}
					else if(result == 4){
						points = 40;
					}
					else if(result == 2){
						points = 70;
					}
					else if(result == 1){
						points = 100;
					}
				}
				else{
					points = 0;
				}

				return points;
			},
			_sortTeams: function(a, b) {  
  
				if(a.name > b.name){
					return -1;
				}
				else if(a.name < b.name){
					return 1;
				}
				else{
					return 0;
				}
			},
			trans: function(key){
				return app.trans(key,this.dictionary);
			}
		});
	</script>

</dom-module>
