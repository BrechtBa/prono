
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<link rel="import" href="../../elements/avatar-image/avatar-image.html">
<link rel="import" href="../../elements/file-input/file-input.html">

<dom-module id="user-profile">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-card{
      			margin-bottom: 5px;
				cursor: pointer;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
    		}
			.buttons{
				text-align: right;
			}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.name{
				padding: 10px;
			}
			.hidden{
				display: none;
			}
			default-dialog .avatar{
				--size: 80px;
			}
			
		</style>

		<!--<iron-ajax id="getUserProfile" url="../../api/index.php/user_profiles" method="GET" handle-as="json" last-response="{{ajaxGetResponse}}" debounce-duration="300"></iron-ajax>
<iron-ajax id="ajaxDelete" method="DELETE" handle-as="json" on-response="handleAjaxDeleteResponse" last-response="{{ajaxDeleteResponse}}" debounce-duration="300"></iron-ajax>-->

		<iron-ajax id="putUserProfile" method="PUT" handle-as="json" on-response="handlePutUserProfileResponse" last-response="{{putUserProfileResponse}}" debounce-duration="300"></iron-ajax>
		

		<paper-card elevation="2">
			<div class="horizontal layout center">
				<avatar-image class="avatar" user="{{user}}"></avatar-image>
				<div class="flex name">{{user.name}}</div>
			</div>

			<div class="buttons">
				<paper-button raised class="primary" on-tap="changeProfileDialog">Edit profile</paper-button>
				<paper-button raised class="secondary" on-tap="changePasswordDialog">Change password</paper-button>
			</div>
		</paper-card>



		<default-dialog id="changeProfileDialog">
			<form is="iron-form" id="changeProfileForm" method="post" on-iron-form-submit="saveProfile" action="/">
				<div class="horizontal layout">
					<avatar-image id="newavatar" class="avatar" user="{{newuser}}"></avatar-image>
					<file-input target="images/avatars/" prepend="{{user.id}}" on-success="setNewAvatar">Change avatar</file-input>
				</div>
			
				<div class="buttons">
					<paper-button raised class="primary" on-tap="changeProfileFormSubmit">Save</paper-button>
					<button type="submit" class="hidden">Save</button>
				</div>
			</form>
		</default-dialog>



		<default-dialog id="changePasswordDialog">
			<form is="iron-form" id="changePasswordForm" method="post" on-iron-form-submit="savePassword" action="/">
				
			</form>
			<div class="buttons">
				<paper-button raised class="primary" on-tap="changePasswordFormSubmit">Save</paper-button>
				<button type="submit" class="hidden">Save</button>
			</div>
		</default-dialog>


	</template>

	<script>
		Polymer({
			is: 'user-profile',
			properties: {
				token: {
					type: 'String',
					value: '',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true
				}
			},
			ready: function(){
			},
			setNewAvatar: function(e,detail){
				this.set('newuser.avatar', detail.url);
			},
			getUser: function(users,user_id){
				var user = {};				
				users.forEach(function(item){
					if(item.user_id == user_id){
						user = item;
					}
				});
				return user;
			},
			changeProfileDialog: function(){
				this.newuser = {'user_id': this.user.user_id, 'name': this.user.name, 'avatar': this.user.avatar};
				this.$.changeProfileDialog.open();
			},
			changePasswordDialog: function(){
				this.$.changePasswordDialog.open();
			},
			changeProfileFormSubmit: function(){
				this.$.changeProfileDialog.close();

				this.$.putUserProfile.headers['Authentication'] = this.token;
				this.$.putUserProfile.url = 'api/index.php/user_profiles/user_id/'+this.user.user_id;
				this.$.putUserProfile.body = JSON.stringify({'name': this.newuser.name, 'avatar': this.newuser.avatar});

				this.$.putUserProfile.generateRequest();
				
			},
			handlePutUserProfileResponse: function(){
				this.set('user.name', this.newuser.name);
				this.set('user.avatar', this.newuser.avatar);
				app.$.model.fire('get-users');
			}

		});
	</script>

</dom-module>
