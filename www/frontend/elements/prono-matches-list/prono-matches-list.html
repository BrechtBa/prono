
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<link rel="import" href="../../elements/default-dialog/default-dialog.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module is="prono-matches-list">
	<template>

		<style>
			:host{
			}
			paper-card{
      			margin-bottom: 5px;
				cursor: pointer;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
    		}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.date{
				text-align: right;
			}
			.teams{
				margin-top: 8px;
				font-size: 18px;
			}
			.team{
				text-align: center;
			}
			.score{
				width: 100px;
				text-align: center;
			}
			.closeDialog{
				position: absolute;
				top: -20px;
				right: 10px;
				margin: 0px;
				cursor: pointer;
			}
		</style>
		

		<template is="dom-repeat" items="{{matchesModel}}" as="match" sort="_sortMatches">
			<paper-card elevation="2" on-tap="editMatch" class="horizontal layout">
				<div class="flex vertical layout">
					<div class="horizontal layout">
						<div class="date flex">
							{{formatDate(match.date)}}
						</div>
					</div>
					<div class="horizontal layout center">
						<div class="flex-1">Stage: {{match.stage}}</div>
						<div class="flex-2">Group: {{match.grp}}</div>
					</div>
					<div class="teams horizontal layout">
						<div class="team flex-1">
							<div>{{match.defaultteam1}}</div>
							<div>{{formatTeamName(match.team1,teamsModel)}}</div>
						</div>
						<div class="score horizontal layout center center-justified">
							<div><span>{{formatScore(match.score1)}}</span> - <span>{{formatScore(match.score2)}}</span></div>
							<div hidden="{{!penaltiesTaken(match)}}">(<span>{{match.penalty1}}</span> - <span>{{match.penalty2}}</span>)</div>												
						</div>
						<div class="team flex-1">
							<div>{{match.defaultteam2}}</div>
							<div>{{formatTeamName(match.team2,teamsModel)}}</div>
						</div>
					</div>
				</div>
			</paper-card>
		</template>
		<paper-button raised on-tap="addMatch">Add match</paper-button>
	
	
		<default-dialog id="editMatch">
			<paper-input label="Date" value={{newdate}} auto-validate pattern="[0-9][0-9]-[0-9][0-9]-[0-9][0-9][0-9][0-9] [0-9][0-9]:[0-9][0-9]" error-message="dd-mm-yyyy HH:MM"></paper-input>
			<div class="horizontal layout wrap">
				<div class="flex-4">
					<paper-input label="Stage" value={{match.stage}}></paper-input>
				</div>
				<div class="flex"></div>
				<div class="flex-4">
					<paper-input label="Group" value={{match.grp}}></paper-input>
				</div>
				<div class="flex"></div>
				<div class="flex-4">
					<paper-input label="Position" value={{match.position}}></paper-input>
				</div>
			</div>
			<div class="horizontal layout wrap">
				<div class="flex-5">
					<paper-input label="Default team 1" value={{match.defaultteam1}}></paper-input>
				</div>
				<div class="flex"></div>
				<div class="flex-5">
					<paper-input label="Default team 2" value={{match.defaultteam2}}></paper-input>
				</div>
			</div>	
			<div class="horizontal layout wrap">
				<div class="flex-5">
					<paper-dropdown-menu id="team1" label="Team 1">
						<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{match.team1}}">
							<paper-item value="0"></paper-item>
							<template is="dom-repeat" items="{{teamsModel}}" as="team" sort="_sortTeams">
								<paper-item value="{{team.id}}">{{team.name}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>
				</div>
				<div class="flex"></div>
				<div class="flex-5">
					<paper-dropdown-menu id="team2" label="Team 2">
						<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{match.team2}}">
							<paper-item value="0"></paper-item>
							<template is="dom-repeat" items="{{teamsModel}}" as="team" sort="_sortTeams">
								<paper-item value="{{team.id}}">{{team.name}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>
				</div>
			</div>	
			<div class="horizontal layout wrap">
				<div class="flex-5">
					<paper-input label="Score 1" value={{newscore1}} auto-validate pattern="[0-9]*" error-message="not a valid score"></paper-input>
				</div>
				<div class="flex"></div>
				<div class="flex-5">
					<paper-input label="score 2" value={{newscore2}} auto-validate pattern="[0-9]*" error-message="not a valid score"></paper-input>
				</div>
			</div>
			<div class="horizontal layout wrap">
				<div class="flex-5">
					<paper-input label="Penalty 1" value={{newpenalty1}} auto-validate pattern="[0-9]*" error-message="not a valid score"></paper-input>
				</div>
				<div class="flex"></div>
				<div class="flex-5">
					<paper-input label="Penalty 2" value={{newpenalty2}} auto-validate pattern="[0-9]*" error-message="not a valid score"></paper-input>
				</div>
			</div>
			<div class="buttons">
				<paper-button raised class="primary" on-tap="saveMatch">Save</paper-button>
				<paper-button raised on-tap="deleteMatch">Delete</paper-button>
			</div>
		</default-dialog>

	</template>
	<script>
		Polymer({
			is: 'prono-matches-list',
			properties: {
				teamsModel: {
					type: 'Array'
				},
				matchesModel: {
					type: 'Array'
				},
				groups: {
					type: 'Array'
				}
			},
			ready: function(){
			},
			closeDialog: function(){
				this.$.editMatch.close();
			},
			editMatch: function(e){
				this.match = e.model.__data__.match

				// some properties need to be formatted
				this.newdate = this.formatDate(this.match.date);
				this.newscore1 = this.formatScore(this.match.score1);
				this.newscore2 = this.formatScore(this.match.score2);
				this.newpenalty1 = this.formatScore(this.match.penalty1);
				this.newpenalty2 = this.formatScore(this.match.penalty2);

				this.$.editMatch.open();
			},
			saveMatch: function(){
				this.$.editMatch.close();

				// javascript only accepts mm-dd-yyyy format so reformatting is in order
				var parts = this.newdate.split(' ');
				var dateparts = parts[0].split('-');
				var timeparts = parts[1].split(':');
   				var date = Date.parse(dateparts[1]+'-'+dateparts[0]+'-'+dateparts[2]+' '+timeparts[0]+':'+timeparts[1])/1000;

				var score1 = this.newscore1;
				if(score1 == ''){
					score1 = -1;
				}
				var score2 = this.newscore2;
				if(score2 == ''){
					score2 = -1;
				}

				var penalty1 = this.newpenalty1;
				if(penalty1 == ''){
					penalty1 = -1;
				}
				var penalty2 = this.newpenalty2;
				if(penalty2 == ''){
					penalty2 = -1;
				}
				
				app.$.model.$.matchesModel.put(this.match.id,{'date':date,'stage':this.match.stage,'grp':this.match.grp,'position':this.match.position,'defaultteam1':this.match.defaultteam1,'defaultteam2':this.match.defaultteam2,'team1':this.match.team1,'team2':this.match.team2,'score1':score1,'score2':score2,'penalty1':penalty1,'penalty2':penalty2})
				app.$.model.$.checkUpdateModel.put('1',{'time':Math.floor( new Date().getTime()/1000)});
			},
			addMatch: function(){
				app.$.model.$.matchesModel.post({'score1':-1,'score2':-1,'penalty1':-1,'penalty2':-1});
				app.$.model.$.checkUpdateModel.put('id/1',{'time':Math.floor( new Date().getTime()/1000)});
			},
			deleteMatch: function(){
				this.$.editMatch.close();
				app.$.model.$.matchesModel.delete('id/'+this.match.id)
				app.$.model.$.checkUpdateModel.put('id/1',{'time':Math.floor( new Date().getTime()/1000)});
			},
			formatDate: function(timestamp){
				var date = new Date(timestamp * 1000);
				var day = date.getDate();
				var month = (date.getMonth()+1)
				var year = date.getFullYear();
				var hours = date.getHours();
				var minutes = date.getMinutes();
				return (day < 10? '0' : '') + day + '-' + (month < 10? '0' : '') + month + '-' + date.getFullYear() + ' ' + (hours < 10? '0' : '') + hours + ':' +  (minutes < 10? '0' : '') + minutes;
			},
			formatScore: function(score){
				if(score<0){
					return '';
				}
				else{
					return score;
				}
			},
			formatTeamName: function(id,teamsModel){
				var name = '';
				teamsModel.forEach(function(item){
					if(item.id == id){
						name = item.name;
					}
				});
				return name;
			},
			formatGroupName: function(id,groups){
				var name = '';
				groups.forEach(function(item){
					if(item.id == id){
						name = item.name;
					}
				});
				return name;
			},
			penaltiesTaken: function(match){
				if(match.penalty1 > -1 || match.penalty2 > -1){
					return true;
				}
				else{
					return false;
				}
			},
			_sortMatches: function(a, b) {  
  
				if(parseInt(a.date) > parseInt(b.date)){
					return 1;
				}
				else if(parseInt(a.date) < parseInt(b.date)){
					return -1;
				}
				else{
					return 0;
				}
			},
			_sortTeams: function(a, b) {  
  
				if(parseInt(a.name) > parseInt(b.name)){
					return 1;
				}
				else if(parseInt(a.name) < parseInt(b.name)){
					return -1;
				}
				else{
					return 0;
				}
			},
			
		});
	</script>
</dom-module>
