
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/default-dialog/default-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module id="prono-knockoutstage-teams">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.stage{
				transition: width 0.5s;
				-webkit-transition: width 0.5s;
			}
			.stage.expanded{
				@apply(--layout-flex-5);
			}
			.stage.collapsed{
				@apply(--layout-flex-2);
			}
			paper-material{
				cursor: pointer;
      			margin: 5px;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
				border-radius: 2px;
    		}
			paper-material h3{
				margin-top: 0px;
			}
			.stage{
				position: relative;
			}
			.disabled .stage::after{
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(1,1,1,0.3);
				border-radius: 2px;
			}
			.team{
				width: 24%;
				min-width: 140px;
			}
			.teamicon{
				width: 90%;
				max-width: 30px;
				height: auto;
				margin-top: 1px;
				margin-bottom: 1px;
				margin-right: 5px;
			}
			.teamname{
				text-align: center;
				margin-top: 5px;
				margin-bottom: 5px;
			}
			.selectable{
				cursor: pointer;
			}
			.selected{
				background-color: #dddddd;
			}
		</style>

		<api-model id="prono" token="{{token}}" url="http://pronoapi.duckdns.org/pronoknockoutstageteams/" model="{{prono}}"></api-model>
		<prono-check prono="[[prono]]" date="[[tokenPayload.access_exp]]" condition="(prono.team>-1  && prono.team != null)"></prono-check>
		
		<div class="horizontal layout center-justified">
			<div class="flex vertical layout">
				<template is="dom-repeat" items="{{getStages(stagesModel)}}" as="stage">

					<div class$="{{disabledClass(currentStage)}} vertical-layout">
						<paper-material elevation="2" class$="stage {{stageClass(stage.id)}} vertical layout" on-tap="editTeams">
							<h3>{{formatStageText(stage.id)}}</h3>
							<div class="horizontal layout center-justified wrap">
								<template is="dom-repeat" items="{{getPronoTeamStage(teamsModel,prono,stage.id)}}" as="team" sort="_sortTeams">
									<div class="team horizontal layout center">
										<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
										<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
									</div>
								</template>
							</div>
						</paper-material>
					</div>

				</template>
			</div>
		</div>

		<default-dialog id="editTeams">
			<div class="before-scrolling">{{selectionsRemaining}} {{trans('selections remaining')}}</div>
			<form is="iron-form" id="form" on-iron-form-submit="save" action="/">

				<template is="dom-repeat" items="{{teamsModel}}" as="team">
	        		<div class$="horizontal layout center {{selectedClass(team,selectedTeams)}} selectable" on-tap="selectTeam">
						<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
						<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
					</div>
				</template>

				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmit">{{trans('Save')}}</paper-button>
					<button type="submit" style="display:none;">{{trans('Save')}}</button>
				</div>
			</form>
		</default-dialog>

	</template>

	<script>
		Polymer({
			is: 'prono-knockoutstage-teams',
			properties: {
				token:{
					type: 'String',
					value: ''
				},
				permission: {
					type: 'Number',
					value: 1
				},
				tokenPayload: {
					type: 'Object'
				},
				stagesModel: {
					type: 'Array',
					value: []
				},
				teamsModel: {
					type: 'Array',
					value: []
				},
				matchesModel: {
					type: 'Array',
					value: []
				},
				currentStage: {
					type: 'Number',
					value: 1
				},
				user: {
					type: 'Object',
					value: {}
				},
				databasePrepared: {
					type: 'Number',
				},
			},
			observers:[
				'getProno(token,user,databasePrepared)',
			],
			created: function(){
				// create the local dictionary
				this.dictionary = {};
				this.dictionary['Teams in round of 16:'] 	= {'nl':'Ploegen in de 8e finale:'};
				this.dictionary['Teams in quarterfinal:']	= {'nl':'Ploegen in de kwartfinale:'};
				this.dictionary['Teams in semifinal:'] 		= {'nl':'Ploegen in de halve finale:'};
				this.dictionary['Teams in final:'] 			= {'nl':'Ploegen in de finale:'};
				this.dictionary['Winner:'] 					= {'nl':'Winnaar:'};
				this.dictionary['selections remaining'] 	= {'nl':'Selecties over:'};
			},
			ready: function(){
				console.log('ready');
				var that = this;
				document.addEventListener('clear-prono', function(e){
					that.prono = [];
				});
			},
			getProno: function(token,user,databasePrepared){
				if(databasePrepared!=1 || typeof user.id == 'undefined' || token == ''){
					this.prono = [];
				}
				else{
					this.$.prono.get('?user='+user.id);
				}
			},
			getStages: function(stagesModel){
				// filter knockoutstages
				var stages = stagesModel.filter(function(item){
					return (item.type=='knockoutstage');
				});

				// sort
				stages.sort(function(a,b){
					if(a.numberofteams>b.numberofteams){
						return -1;
					}
					else if(a.numberofteams<b.numberofteams){
						return 1;
					}
					else{
						return 0;
					}
				});

				// remove the 1st stage after the group stage
				if(stages.length>0){
					stages.shift()
				}

				// add the winner
				stages.push({'id':1, 'numberofteams':1});

				return stages;
			},
			getPronoTeamStage: function(teamsModel,prono,stage){
				var teams = []
				var stageProno = this.prono.filter(function(prono){
					return ( prono.stage == stage );
				});

				stageProno.forEach(function(prono){
					var team = teamsModel.filter(function(team){
						return team.id == prono.team;
					});
					if(team.length>0){
						teams.push( team[0] );
					}
				});

				return teams;
			},
			formatStageText: function(stage){
				stage = parseInt(stage)
				var text = ''
				switch(stage){
					case 16:
						text = this.trans('Teams in round of 16:');
						break;
					case 8:
						text = this.trans('Teams in quarterfinal:');
						break;
					case 4:
						text = this.trans('Teams in semifinal:');
						break;
					case 2:
						text = this.trans('Teams in final:');
						break;
					case 1:
						text = this.trans('Winner:');
						break;
					default:
						text = '';
				}
				return text;
			},
			stageClass: function(stage){
				return 'stage-'+stage;
			},
			disabledClass: function(currentStage){
				if(currentStage==0 || currentStage==-1){
					return '';
				}
				else{
					return 'disabled';
				}
			},
			formatTeamName: function(id,teamsModel){
				var name = '';
				teamsModel.forEach(function(item){
					if(item.id == id){
						name = item.name;
					}
				});
				return name;
			},
			getTeam: function(id,teamsModel){
				var team = {};
				teamsModel.forEach(function(item){
					if(item.id == id){					
						team = item;
					}
				});
				return team;
			},
			editTeams: function(e){
				var editStage = e.model.__data__.stage;
				if(this.currentStage==0 || this.currentStage==-1){
					this.editStage = editStage;

					var selectedTeams = []
					var stageProno = this.prono.filter(function(prono){
						return ( prono.stage == editStage.id );
					});

					stageProno.forEach(function(prono){
						if(prono.team != null){
							selectedTeams.push(prono.team);
						}
					});
					this.selectedTeams = selectedTeams;
					this.selectionsRemaining = parseInt(editStage.numberofteams) - this.selectedTeams.length

					this.$.editTeams.open();
				}
			},
			selectTeam: function(e){
				var team_id = e.model.__data__.team.id;

				var selectedTeams = JSON.parse(JSON.stringify(this.selectedTeams));
				var index = selectedTeams.indexOf(team_id);
				if( index > -1 ){
					// remove the team
					selectedTeams.splice(index, 1);
				}
				else if(parseInt(this.editStage.numberofteams) - this.selectedTeams.length > 0){
					// add the team
					selectedTeams.push(team_id);
				}
				this.selectedTeams = selectedTeams;

				this.selectionsRemaining = parseInt(this.editStage.numberofteams) - this.selectedTeams.length;
			},
			selectedClass: function(team,selectedTeams){
				if( selectedTeams.indexOf(team.id)>-1){
					return 'selected';
				}
				else{
					return '';
				}
			},
			formSubmit: function(){
				this.$.form.submit();
			},
			save: function(){
				this.$.editTeams.close();

				var that = this;
				var teams = this.teamsModel.filter(function(team){
					return (that.selectedTeams.indexOf(team.id)>-1);
				});			
				teams.sort(this._sortTeams);

				var stageProno = this.prono.filter(function(prono){
					return (prono.stage == that.editStage.id);
				});

				stageProno.forEach(function(prono,index){
					if(typeof teams[index] != 'undefined'){
						that.$.prono.put(prono.id+'/',{'team':teams[index].id});
					}
					else{
						that.$.prono.put(prono.id+'/',{'team':null});
					}
				});
			},
			_sortTeams: function(a, b) {  
  
				if( a.name > b.name ){
					return 1;
				}
				else if( a.name < b.name ){
					return -1;
				}
				else{
					return 0;
				}
			},
			trans: function(key){
				return app.trans(key,this.dictionary);
			}
		});
	</script>

</dom-module>
