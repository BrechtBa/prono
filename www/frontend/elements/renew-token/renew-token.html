
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">

<dom-module is="renew-token">
	<template>
		<style>
			:host{
			}
		</style>

		<parse-token token="{{token}}" payload="{{payload}}"></parse-token>
		<iron-ajax id="authenticate" url="../../api/authenticate.php" method="POST" handle-as="json" on-response="handleAuthenticateResponse" last-response="{{authenticateResponse}}" debounce-duration="300"></iron-ajax>

	</template>

	
	
	<script>
		Polymer({
			is: 'renew-token',
			properties: {
				token: {
					type: 'String',
					value: '',
					notify: true
				},
				payload: {
					type: 'Object',
					value: {},
					observer: 'payloadChanged'
				},
			},
			payloadChanged: function(payload){
				if(typeof payload['db_exp'] != 'undefined'){
					that = this;
					var now = new Date();
					timeuntilrenewal = Math.min(24*3600*1000,Math.max(1,payload['access_exp']*1000-now));

					setTimeout(function(){
						console.log('renew token');

						that.$.authenticate.headers['Authentication'] = that.token;
						that.$.authenticate.generateRequest();

					}, timeuntilrenewal);
				}
			},
			handleAuthenticateResponse: function(){
				if(this.authenticateResponse != ''){
					this.token = this.authenticateResponse;
				}
			},
		});
	</script>
</dom-module>
