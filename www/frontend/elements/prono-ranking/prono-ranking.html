
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<link rel="import" href="../../elements/default-dialog/default-dialog.html">
<link rel="import" href="../../elements/avatar-image/avatar-image.html">

<dom-module id="prono-ranking">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-card{
      			margin-bottom: 5px;
				cursor: pointer;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
    		}
			paper-card.me{
				margin-left: 5px;
				margin-right: -5px;
			}
			.ranking{
				width: 30px;
				font-weight: 600;
			}
			.name{
				padding: 10px;
			}
			.points{
				width: 40px;
				margin-left: 20px;
			}
			
		</style>

		<api-model id="pointsTotal" token="[[token]]" url="http://pronoapi.duckdns.org/points/?prono=total" model="{{pointsTotal}}"></api-model>
		<api-model id="pointsDetail" token="[[token]]" url="http://pronoapi.duckdns.org/points/" model="{{pointsDetail}}" on-change="handlePointsDetailChange"></api-model>
		
		<template is="dom-if" if="{{displayWaitMessage}}">
			{{trans('Please wait while the database is prepared.')}}
		</template>

		<template is="dom-repeat" items="{{pointsTotal}}" as="points" sort="_sortUsers">
			<paper-card elevation="2" class$="horizontal layout center {{userClass(points.user,user)}}" on-tap="showPointDetails">
				<div class="ranking">{{ranking(index)}}</div>
				<avatar-image class="avatar" user-profile="{{getUser(points.user,usersModel)}}"></avatar-image>
				<div class="flex name">{{getUserName(points.user,usersModel)}}</div>
				<div class="points">{{points.points}}</div>
			</paper-card>
		</template>

		<default-dialog id="pointDetails">
			<div class="vertical layout">
				<template is="dom-repeat" items="{{pointsDetail}}" as="points" filter="_notTotal">
					<div class="horizontal layout">
						<div class="flex">{{trans(points.prono)}}:</div>
						<div class="points">{{points.points}}</div>
					</div>
				</template>
			</div>
			<hr>
			<div class="horizontal layout">
				<div class="flex total">{{trans('Total')}}:</div>
				<div class="points">{{total}}</div>
			</div>
		</default-dialog>
	

	</template>

	<script>
		Polymer({
			is: 'prono-ranking',
			properties: {
				token:{
					type: 'String',
					value: ''
				},
				permission: {
					type: 'Number',
					value: 1
				},
				usersModel: {
					type: 'Array',
					value: []
				},
				user: {
					type: 'Object'
				},
				databasePrepared: {
					type: 'Number',
				},
			},
			observers:[
				'getPointsTotal(token,user,usersModel,databasePrepared)',
			],
			created: function(){
				// create the local dictionary
				this.dictionary = {};
				this.dictionary['Please wait while the database is prepared.'] = {'nl':'Even geduld, de database wordt voorbereid.'}
				this.dictionary['groupstage_result'] 	= {'nl':'Groepsfase resultaat'};
				this.dictionary['groupstage_score'] 	= {'nl':'Groepsfase score'};
				this.dictionary['knockoutstage_result'] = {'nl':'Knockout fase resultaat'};
				this.dictionary['knockoutstage_score'] 	= {'nl':'Knockout fase score'};
				this.dictionary['groupstage_winners'] 	= {'nl':'Winnaars groepsfase'};
				this.dictionary['knockoutstage_teams']	= {'nl':'Knockout fase ploegen'};
				this.dictionary['total_goals'] 			= {'nl':'Aantal goals'};
				this.dictionary['team_result'] 			= {'nl':'Ploeg resultaat'};
				this.dictionary['Total'] 				= {'nl':'Totaal'};

			},
			ready: function(){
				console.log('ready');
				this.displayWaitMessage = true;
				// add event listeners
				var that = this;
				document.addEventListener('update-points', function(e){
					that.getPointsTotal(that.token,that.user);
				});
			},
			getPointsTotal: function(token,user,usersModel,databasePrepared){
				console.log(this.displayWaitMessage)
				if(typeof user.id == 'undefined' || token == '' || databasePrepared==0){
					this.pointsTotal = [];
					this.displayWaitMessage = true;
				}
				else{
					this.$.pointsTotal.get();
					this.displayWaitMessage = false;
				}
			},
			getUser: function(id,usersModel){
				var user = {};
				usersModel.forEach(function(tempuser){
					if(id == tempuser.user){
						user = tempuser;
					}
				});
				return user;
			},
			getUserName: function(id,usersModel){
				var user = this.getUser(id,usersModel);
				if( typeof user != 'undefined'){
					return user.displayname;
				}
			},
			ranking: function(index){
				return index+1;
			},
			showPointDetails: function(e){
				var points = e.model.__data__.points;
				var user = this.getUser(points.user,this.usersModel);

				this.pointsDetail = [];
				this.$.pointDetails.close();
				this.total = 0;

				// get the points
				if(user.user == this.user.id || this.permission >8){
					this.$.pointsDetail.get('?user='+user.user);

					this.$.pointDetails.open();
				}
			},
			handlePointsDetailChange: function(e){
				var total = 0;
				this.pointsDetail.forEach(function(points){
					if(points.prono=='total'){
						total = points.points;
					}
				});
				this.total = total;
			},
			userClass: function(id,user){
				var cl = '';
				try{
					if(user.id == id){
						cl = 'me';
					}
				}
				catch(e){
				}
				return cl;
			},
			_getAvatar: function(src){
				if(src==''){
					return ''
				}
				else{
					return src;
				}
			},	
			_sortUsers: function(a,b){  
				if(parseFloat(a.points) > parseFloat(b.points)){
					return -1;
				}
				else if(parseFloat(a.points) < parseFloat(b.points)){
					return 1;
				}
				else{
					return 0;
				}
			},
			_notTotal: function(points){
				return (points.prono != 'total');
			},
			trans: function(key){
				return app.trans(key,this.dictionary);
			}
		});
	</script>

</dom-module>
