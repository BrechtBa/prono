
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-base">
	<template>

		<style>
			
		</style>

		<api-model id="prono" token="{{token}}" url="{{url}}/user_id/{{user.id}}" model="{{prono}}" on-change="handlePronoChange"></api-model>
		<api-model id="allProno" token="{{token}}" url="{{url}}" model="{{allProno}}" on-change="handleAllPronoChange"></api-model>

	</template>

	<script>
		Polymer({
			is: 'prono-base',
			properties: {
				name: {
					type: 'String',
					value: ''
				},
				url: {
					type: 'String',
					value: ''
				},		
				token:{
					type: 'String',
					value: ''
				},
				permission: {
					type: 'Number',
					value: 1
				},
				prono: {
					type: 'Array',
					notify: true
				},
				defaultProno: {
					type: 'Array',
				},
				user: {
					type: 'Object',
					value: {}
				},
				functions: {
					type: 'Object',
					value: {
						'checkDefaultProno': function(prono,defaultProno){return false;};
						'calculatePronoPoints': function(prono){return 0;},
					}
				},	
			},
			ready: function(){
				console.log('ready');
				// add global event listeners
				var that = this;
				document.addEventListener('prono-model-changed', function(e){
					that.$.prono.get();
				});
				document.addEventListener('calculate-user-points', function(e){
					var user_id = e.detail;
					that.calculateUserPoints(user_id);
				});
			},
			handlePronoChange: function(){
				var done = true;
				console.log('check prono '+ this.name);
				try{
					if(typeof this.user.id != 'undefined'){
						var that = this;


						this.defaultProno.every(function(defProno){
							var found = true;
							// check if the prono is in the database model
							found = false;
							that.prono.forEach(function(prono){
								if( that.functions.checkDefaultProno(prono,defProno) ){
									found = true;
								}

							});

							if( !found ){
								done = false;
								// the prono must be created
								console.log('adding to ' this.name + ' database: ' + json.stringify(defProno) );
								that.$.prono.post(defProno);
							}
							
							return found;
						});


					}
					else{
						this.prono = [];
					}
				}
				catch(e){
				}
				
				// proceed to the next step
				if(done){
					this.$.allProno.get();
				}
			},
			handleAllPronoChange: function(){
				if(this.permission > 5){
					var that = this;
					var points = {};
					this.allProno.forEach(function(prono){
						if( !(prono.user_id in points) ){
							points[prono.user_id] = 0;
						}
						points[prono.user_id] += that.calculatePronoPoints(prono);
		
					});
					this.fire(this.name + '-points-changed',points);
				}
			},
			calculateUserPoints: function(user_id){
				if(typeof this.user.id != 'undefined'){
					var that = this;
					var points = 0;
					if(user_id == this.user.id){
						var prono = this.prono;
					}
					else if(this.permission > 8){
						var prono = this.allProno.filter(function(prono){
							return (prono.user_id == user_id);
						});
					}
					prono.forEach(function(prono){
						points += that.calculatePronoPoints(prono);
					});
					this.fire('user-points',{'prono':this.name, 'points':points});
				}
			},
			calculatePronoPoints: function(prono){
				return this.functions.calculatePronoPoints(prono);
			},
			put: function(selector,data){
				this.$.prono.put(selector,data);
			}
		});
	</script>

</dom-module>
