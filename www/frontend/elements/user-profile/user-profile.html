
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<link rel="import" href="../../elements/avatar-image/avatar-image.html">
<link rel="import" href="../../elements/file-input/file-input.html">
<link rel="import" href="../../elements/custom-validator/custom-validator.html">
<link rel="import" href="../../elements/default-dialog/default-dialog.html">

<dom-module id="user-profile">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-card{
      			margin-bottom: 5px;
				cursor: pointer;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
				width: 100%;
    		}
			.buttons{
				margin-top: 20px;
				text-align: right;
			}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.avatar{
				--size: 80px;
				--radius: 40px;
			}
			.name{
				padding: 10px;
			}
			.hidden{
				display: none;
			}
			
		</style>

		<paper-card elevation="2">
			<div class="horizontal layout center">
				<avatar-image class="avatar" user="{{user}}"></avatar-image>
				<div class="flex name">{{user.name}}</div>
			</div>

			<div class="buttons">
				<paper-button raised class="primary" on-tap="changeProfileDialog">{{trans('Edit profile')}}</paper-button>
				<!--<paper-button raised class="secondary" on-tap="changePasswordDialog">{{trans('Change password')}}</paper-button>-->
			</div>
		</paper-card>



		<default-dialog id="changeProfileDialog">
			<form is="iron-form" id="changeProfileForm" method="post" on-iron-form-submit="saveProfile" action="/">
				<div class="horizontal layout">
					<avatar-image id="newavatar" class="avatar" user="{{newuser}}"></avatar-image>
					<file-input target="images/avatars/" prepend="{{user.id}}" on-success="setNewAvatar">{{trans('Change avatar')}}</file-input>
				</div>
			
				<div class="buttons">
					<paper-button raised class="primary" on-tap="changeProfileFormSubmit">{{trans('Save')}}</paper-button>
					<button type="submit" class="hidden">{{trans('Save')}}</button>
				</div>
			</form>
		</default-dialog>



		<default-dialog id="changePasswordDialog">
			<form is="iron-form" id="changePasswordForm" method="post" on-iron-form-submit="savePassword" action="/">
				<paper-input id="oldpassword" label="Old password:" type="password" required auto-validate error-message="required"></paper-input>
				<paper-input id="newpassword" label="New password:" type="password" required auto-validate error-message="required"></paper-input>
				<paper-input id="newpasswordrepeat" label="Repeat new Password:" type="password" required auto-validate error-message="does not match" validator="passwordValidator"></paper-input>
				<custom-validator id="passwordValidator" validator-name="passwordValidator"></custom-validator>
			</form>
			<div class="buttons">
				<paper-button raised class="primary" on-tap="changePasswordFormSubmit">{{trans('Save')}}</paper-button>
				<button type="submit" class="hidden">{{trans('Save')}}</button>
			</div>
		</default-dialog>


	</template>

	<script>
		Polymer({
			is: 'user-profile',
			properties: {
				token: {
					type: 'String',
					value: '',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true
				}
			},
			created: function(){
				// create the local dictionary
				this.dictionary = {};
				this.dictionary['Edit profile'] 	= {'nl':'Profiel aanpassen'};
				this.dictionary['Change password'] 	= {'nl':'Verander wachtwoord'};
				this.dictionary['Change avatar'] 	= {'nl':'Verander avatar'};
			},
			ready: function(){
				this.$.passwordValidator.validate = this.passwordValidator.bind(this);
			},
			setNewAvatar: function(e,detail){
				this.set('newuser.avatar', detail.url);
			},
			getUser: function(users,user_id){
				var user = {};				
				users.forEach(function(item){
					if(item.user_id == user_id){
						user = item;
					}
				});
				return user;
			},
			changeProfileDialog: function(){
				this.newuser = {'user_id': this.user.user_id, 'name': this.user.name, 'avatar': this.user.avatar};
				this.$.changeProfileDialog.open();
			},
			changeProfileFormSubmit: function(){
				this.$.changeProfileForm.submit();
			},
			saveProfile: function(){
				this.$.changeProfileDialog.close();
				app.$.model.$.usersModel.put('user_id/'+this.user.user_id,{'name': this.newuser.name, 'avatar': this.newuser.avatar});
			},
			handlePutUserProfileResponse: function(){
				this.set('user.name', this.newuser.name);
				this.set('user.avatar', this.newuser.avatar);
				app.$.model.fire('get-users');
			},
			changePasswordDialog: function(){
				this.$.changePasswordDialog.open();
			},
			changePasswordFormSubmit: function(){
				this.$.changePasswordForm.submit();
			},
			savePassword: function(){
				this.$.changePasswordDialog.close();

				/*this.$.putUserProfile.headers['Authentication'] = this.token;
				this.$.putUserProfile.url = 'api/index.php/user_profiles/user_id/'+this.user.user_id;
				this.$.putUserProfile.body = JSON.stringify({'name': this.newuser.name, 'avatar': this.newuser.avatar});

				this.$.putUserProfile.generateRequest();*/

			},
			passwordValidator: function(){
				if(this.$.newpassword.value == this.$.newpasswordrepeat.value){
            		return true;
				}
				else{
            		return false;
				}
			},
			trans: function(key){
				return app.trans(key,this.dictionary);
			}
		});
	</script>

</dom-module>
