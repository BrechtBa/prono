
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/default-dialog/default-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module id="prono-team-result">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-material{
      			margin: 5px;
				cursor: pointer;
				padding: 10px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
				border-radius: 2px;
    		}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.disabled::after{
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(1,1,1,0.3);
				border-radius: 2px;
			}
			.hidden{
				display: none;
			}
			.team{
				width: 24%;
				min-width: 140px;
			}
			.teamicon{
				width: 90%;
				max-width: 30px;
				height: auto;
				margin-top: 1px;
				margin-bottom: 1px;
				margin-right: 5px;
			}
			.teamname{
				text-align: center;
				margin-top: 5px;
				margin-bottom: 5px;
			}
			.selected{
				background-color: #dddddd;
			}
		</style>

		<!--<api-model id="teamIds" token="{{token}}" url="../../api/index.php/prono_team_result_teams/" model="{{teamIds}}" on-change="handleTeamIdsChange"></api-model>-->

		<api-model id="prono" token="{{token}}" url="http://pronoapi.duckdns.org/pronoteamresult/" model="{{prono}}"></api-model>
		
		<template is="dom-if" if="{{isProno(user)}}">
			<paper-material class$="{{disabledClass(currentStage,user)}}" elevation="2">
				<h3>{{trans('Team result')}}:</h3>
				<template is="dom-repeat" items="{{getTeams(teamIds,teamsModel)}}" as="team" sort="_sortTeams">
					<div class="horizontal layout center wrap" on-tap="editResult">
						<div class="team horizontal layout center">
							<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
							<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
						</div>
						<div>
							<h3>{{getParsedResult(prono,team.id)}}</h3>
						</div>
					</div>
				</template>	
			</paper-material>
		</template>

		<!--<template is="dom-if" if="{{!isProno(user)}}">
			<paper-material class="horizontal layout" elevation="2" on-tap="editTeams">
				<div class="horizontal layout center-justified wrap">
					<template is="dom-repeat" items="{{getTeams(teamIds,teamsModel)}}" as="team" sort="_sortTeams">
						<div class="team horizontal layout center">
							<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
							<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
						</div>
					</template>
				</div>
			</paper-material>
		</template>-->




		<default-dialog id="editResult">
			<form is="iron-form" id="formProno" on-iron-form-submit="saveProno" action="/">
				<div class="horizontal layout center">
					<prono-team-icon class="teamicon" team="{{editTeam}}"></prono-team-icon>
					<prono-team-name class="teamname" team="{{editTeam}}"></prono-team-name>
				</div>
				<paper-dropdown-menu label="{{trans('Result')}}">
					<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{result}}">
						<paper-item value="-1"></paper-item>
						<template is="dom-repeat" items="{{getStages(stagesModel)}}" as="stage">
							<paper-item value="{{stage.id}}">{{parseResult(stage.id)}}</paper-item>
						</template>
					</paper-menu>
				</paper-dropdown-menu>


				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmitProno">{{trans('Save')}}</paper-button>
					<button type="submit" class="hidden">{{trans('Save')}}</button>
				</div>
			</form>
		</default-dialog>


		<!--<default-dialog id="editTeams">
			<form is="iron-form" id="formConfig" method="post" on-iron-form-submit="saveConfig" action="/">
				<template is="dom-repeat" items="{{teamsModel}}" as="team">
	        		<div class$="horizontal layout center {{selectedClass(team,teamIds)}}" on-tap="selectTeam">
						<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
						<prono-team-name class="teamname" team="{{team}}"></prono-team-name>
					</div>
				</template>

				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmitConfig">Save</paper-button>
					<button type="submit" style="display:none;">Save</button>
				</div>
			</form>
		</default-dialog>-->


	</template>

	<script>
		Polymer({
			is: 'prono-team-result',
			properties: {
				token: {
					type: 'String',
					value: ''
				},
				permission: {
					type: 'Number',
					value: 1
				},
				currentStage:{
					type: 'Number',
					value: -1
				},
				teamsModel: {
					type: 'Array',
				},
				stagesModel: {
					type: 'Array',
				},
				user: {
					type: 'Object',
					value: {}
				}
			},
			observers:[
				'getProno(token,user)',
			],
			created: function(){
				// create the local dictionary
				this.dictionary = {};
				this.dictionary['Team result'] 						= {'nl':'Ploeg resultaat'};
				this.dictionary['Result'] 							= {'nl':'Resultaat'};
				this.dictionary['eliminated in the groupstage'] 	= {'nl':'geëlimineerd in de groepsfase'};
				this.dictionary['eliminated in the round of '] 		= {'nl':'geëlimineerd in de round of '};
				this.dictionary['eliminated in the round of 16'] 	= {'nl':'geëlimineerd in de 8e finale'};
				this.dictionary['eliminated in the quarter-finals'] = {'nl':'geëlimineerd in de kwartfinale'};
				this.dictionary['eliminated in the semi-finals'] 	= {'nl':'geëlimineerd in de halve finale'};
				this.dictionary['eliminated in the final'] 			= {'nl':'geëlimineerd in de finale'};
				this.dictionary['winner'] 							= {'nl':'winnaar'};
			},
			ready: function(){
				console.log('ready');
				this.teamIds = [3];
			},
			getProno: function(token,user){
				if(typeof user.id == 'undefined' || token == ''){
					this.prono = [];
				}
				else{
					this.$.prono.get('?user='+user.id);
				}
			},
			isProno: function(user){
				return (typeof user.id != 'undefined');
			},
			disabledClass: function(currentStage,user){
				if( 0 == currentStage || typeof user.id == 'undefined'){
					return '';
				}
				else{
					return 'disabled';
				}
			},
			getTeam: function(id,teamsModel){
				var team = {};
				teamsModel.forEach(function(item){
					if(item.id == id){					
						team = item;
					}
				});
				return team;
			},
			getTeams: function(ids,teamsModel){
				var teams = [];
				var that = this;
				ids.forEach(function(id){
					teams.push(that.getTeam(id,teamsModel))
				});
				return teams;
			},
			getStages: function(stagesModel){
				var stages = JSON.parse(JSON.stringify(stagesModel));

				// sort
				stages.sort(function(a,b){
					if(a.numberofteams>b.numberofteams){
						return 1;
					}
					else if(a.numberofteams<b.numberofteams){
						return -1;
					}
					else{
						return 0;
					}
				});

				// add the winner
				stages.push({'id':1, 'numberofteams':1});


				stages.forEach(function(stage){
					stage.id = String(stage.id);
				});

				return stages;
			},
			getResult: function(prono,teamId){
				var result = -1;
				prono.forEach(function(tempprono){
					if(tempprono.team == teamId){
						result = tempprono.result;
					};
				});
				return result;
			},
			getParsedResult: function(prono,teamId){
				return this.parseResult(this.getResult(prono,teamId));
			},
			parseResult: function(result){
				result = String(result)

				var description = '';
				if(result === "0"){
					description = this.trans('eliminated in the groupstage');
				}
				else if(parseInt(result) > 16){
					description = this.trans('eliminated in the round of ')+result;
				}
				else if(result === "16"){
					description = this.trans('eliminated in the round of 16');
				}
				else if(result === "8"){
					description = this.trans('eliminated in the quarter-finals');
				}
				else if(result === "4"){
					description = this.trans('eliminated in the semi-finals');
				}
				else if(result === "2"){
					description = this.trans('eliminated in the final');
				}
				else if(result === "1"){
					description = this.trans('winner');
				}
				return description;
			},
			editResult: function(e){
				if(this.currentStage == 0){
					this.editTeam = e.model.__data__.team;

					var result = this.getResult(this.prono,this.editTeam.id);
					this.result = result;

					this.$.editResult.open();
				}
			},
			formSubmitProno: function(){
				this.$.formProno.submit();
			},
			saveProno: function(){
				this.$.editResult.close();

				var that = this;
				var prono_id = -1;
				this.prono.forEach(function(prono){
					if(prono.team == that.editTeam.id){
						prono_id = prono.id;
					};
				});
				
				var result = parseInt(this.result);
				if(prono_id>0){
					this.$.prono.put(prono_id+'/',{'result': result});
				}
			},
			/*formSubmitConfig: function(){
				this.$.formConfig.submit();
			},
			saveConfig: function(){
				this.$.editTeams.close();

				var that = this;
				var teams = this.teamsModel.filter(function(team){
					return (that.selectedTeams.indexOf(team.id)>-1);
				});			
				teams.sort(this._sortTeams);

				for(var i=1; i<=this.editStage; i++){
					if(typeof teams[i-1] != 'undefined'){
						this.$.teamIds.put('prono_id/stage' + this.editStage + '_' + i,{'team_id':teams[i-1].id});
					}
					else{
						this.$.teamIds.put('prono_id/stage' + this.editStage + '_' + i,{'team_id':-1});
					}
				}
			},*/
			trans: function(key){
				return app.trans(key,this.dictionary);
			}
		});
	</script>

</dom-module>
