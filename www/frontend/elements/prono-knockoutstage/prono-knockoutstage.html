
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/prono-score-dialog/prono-score-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module id="prono-knockoutstage">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			.stage{
				transition: width 0.5s;
				-webkit-transition: width 0.5s;
			}
			.stage.expanded{
				@apply(--layout-flex-5);
			}
			.stage.collapsed{
				@apply(--layout-flex-2);
			}
			paper-material{
      			margin: 5px;
				padding: 0px;
				background: var(--background-secondary-color);
				color: var(--text-secondary-color);
				border-radius: 2px;
    		}
			paper-material h3{
				margin-top: 0px;
			}

			.match{
				height: 80px;
				cursor: pointer;
				overflow: hidden;
				text-align: center;
			}
			.disabled .match::after{
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(1,1,1,0.3);
				border-radius: 2px;
			}
			.spacer{
				height: 80px;
			}
			.stage-4 .spacer{
				height: 50px;
			}
			@media (min-height: 521px){
				.match{
					height: 120px;
				}
				.spacer{
					height: 120px;
				}
				.stage-4 .spacer{
					height: 80px;
				}
			}
			.score{
				text-align: center;
			}
			.dash{
				width: 15px;
			}
			.teamicon{
				width: 90%;
				max-width: 30px;
				height: auto;
				margin-top: 5px;
				margin-bottom: 5px;
			}

			.teamname{
				text-align: center;
				margin-top: 5px;
				margin-bottom: 5px;
			}
			.teamname.left{
			}
			.teamname.right{
			}
		</style>

		<api-model id="prono" token="{{token}}" url="http://pronoapi.duckdns.org/pronoresults/" model="{{prono}}"></api-model>

		<div class="horizontal layout center-justified">
			<div class="flex horizontal layout center">
				<template is="dom-repeat" items="{{getStages(stagesModel,matchesModel)}}" as="stage">
					<div class$="stage {{stageClass(stage)}} {{collapsedClass(stage,expandedStage)}} {{disabledClass(stage,currentStage,user)}} vertical-layout ">
						<template is="dom-repeat" items="{{stage.matches}}" as="match">
							
							<template is="dom-if" if="{{addSpacerBefore(stage,match)}}">
								<div class="spacer"></div>
							</template>

							<paper-material elevation="2" class="match vertical layout" on-tap="editScore">
								<div class="teamname left" hidden="{{hideTeamName(stage,expandedStage)}}">
									<prono-team-name team="{{getTeam(match.team1,teamsModel)}}" default="{{match.defaultteam1}}" abr="{{abreviateTeamName(stage,expandedStage)}}"></prono-team-name>
								</div>
								<div class$="flex {{iconLayoutClass(stage,expandedStage)}} layout center center-justified">
									<div class="flex">
										<prono-team-icon class="teamicon" team="{{getTeam(match.team1,teamsModel)}}"></prono-team-icon>
									</div>
									<div class$="score flex {{scoreLayoutClass(stage,expandedStage)}} layout center center-justified">
										<div>{{getScore1(match,results)}}</div>
										<div class="dash">-</div>
										<div>{{getScore2(match,results)}}</div>
									</div>

									<div class="flex">
										<prono-team-icon class="teamicon" team="{{getTeam(match.team2,teamsModel)}}"></prono-team-icon>
									</div>
								</div>
								<div class="teamname right" hidden="{{hideTeamName(stage,expandedStage)}}">
									<prono-team-name team="{{getTeam(match.team2,teamsModel)}}" default="{{match.defaultteam2}}" abr="{{abreviateTeamName(stage,expandedStage)}}"></prono-team-name>
								</div>
							</paper-material>
							
							<template is="dom-if" if="{{addSpacerAfter(stage,match)}}">
								<div class="spacer"></div>
							</template>


						</template>
					</div>
				</template>
			</div>
		</div>

		<prono-score-dialog id="editScore" teams-model="{{teamsModel}}" matches-model="{{matchesModel}}" result="{{result}}" on-save="saveScore" show-penalties="{{showPenalties(user)}}"></prono-score-dialog>
	</template>

	<script>
		Polymer({
			is: 'prono-knockoutstage',
			properties: {
				token:{
					type: 'String',
					value: ''
				},
				permission: {
					type: 'Number',
					value: 1
				},
				stagesModel:{
					type: 'Array',
					value: []
				},
				teamsModel: {
					type: 'Array',
					value: []
				},
				matchesModel: {
					type: 'Array',
					value: []
				},
				matchrestulsModel: {
					type: 'Array',
					value: []
				},
				pronoScoreModel: {
					type: 'Array',
					value: []
				},
				currentStage: {
					type: 'Number',
					value: 1
				},
				user: {
					type: 'Object',
					value: {}
				},
				databasePrepared: {
					type: 'Number',
				},
			},
			observers:[
				'getProno(token,user,databasePrepared)',
				'getResults(user,matchresultsModel,prono)'
			],
			listeners:{
				'editScore.save': 'saveScore'
			},
			created: function(){
				// create the local dictionary
				this.dictionary = {};
			},
			ready: function(){
				console.log('ready');
				var that = this;
				document.addEventListener('clear-prono', function(e){
					that.prono = [];
				});
			},
			getProno: function(token,user,databasePrepared){
				if(databasePrepared!=1 || typeof user.id == 'undefined' || token == ''){
					this.prono = [];
				}
				else{
					this.$.prono.get('?user='+user.id);
				}
			},
			getResults: function(user,matchresultsModel,prono){
				if(typeof user.id != 'undefined'){
					this.results = this.prono.filter(function(prono){
						return (prono.user == user.id);
					});
				}
				else{
					this.results = matchresultsModel;
				}
			},
			getStages: function(stagesModel,matchesModel){
				var tempstages = [];
				var stages = [];

				// filter knockoutstages
				var tempstages = stagesModel.filter(function(item){
					return (item.type=='knockoutstage');
				});

				if(tempstages.length > 0){
					// sort
					tempstages.sort(function(a,b){
						if(a.numberofteams>b.numberofteams){
							return -1;
						}
						else if(a.numberofteams<b.numberofteams){
							return 1;
						}
						else{
							return 0;
						}
					});

					// get the exapanded stage       fixme
					tempstages.forEach(function(item){
						if(item.numberofteams < this.currentStage){
							this.expandedStage = tempstages[0];
						}
						else{
							this.expandedStage = this.currentStage;
						}
					});
					this.expandedStage = 1;

					//left side
					tempstages.forEach(function(stage){
						if(stage.numberofteams>2){
							var tempmatches = [];
							matchesModel.forEach(function(match){
								if(match.stage == stage.id && match.position < stage.numberofteams/4+1){
									tempmatches.push(match);
								}
							});
							stages.push({'id':parseInt(stage.id),'matches':tempmatches,'side':'left'});
						}
					});

					//final
					var stage = tempstages[tempstages.length-1];
					if(stage.numberofteams==2){
						var teams = [];
						var tempmatches = [];
						matchesModel.forEach(function(match){
							if(match.stage == stage.id){
								tempmatches.push(match);
							}
						});
						stages.push({'id':parseInt(stage.id),'matches':tempmatches,'side':'final'});
					}

					//right side
					tempstages.reverse().forEach(function(stage){
						if(stage.numberofteams>2){
							var tempmatches = [];
							matchesModel.forEach(function(match){
								if(match.stage == stage.id && match.position > stage.numberofteams/4){
									tempmatches.push(match);
								}
							});
							stages.push({'id':parseInt(stage.id),'matches':tempmatches,'side':'right'});
						}
					});
				}
				return stages;
			},
			getScore1: function(match,results){
				var score = -1;
				results.forEach(function(item){
					if(item.match == match.id){
						score = item.score1
					}
				});
				return this.formatScore(score);
			},
			getScore2: function(match,results){
				var score = -1;
				results.forEach(function(item){
					if(item.match == match.id){
						score = item.score2
					}
				});
				return this.formatScore(score)
			},
			formatScore: function(score){
				var val = '';
				if(score<0){
					val = '';
				}
				else{
					val = score;
				}
				return val;
			},
			getTeam: function(id,teamsModel){
				var team = {};
				teamsModel.forEach(function(item){
					if(item.id == id){					
						team = item;
					}
				});
				return team;
			},
			formatTeamName: function(id,teamsModel){
				var name = '';
				teamsModel.forEach(function(item){
					if(item.id == id){
						name = item.name;
					}
				});
				return name;
			},
			editScore: function(e){
				var match = e.model.__data__.match;

				if(match.stage == this.expandedStage || !this.isSmall()){
					if( (typeof this.user.id == 'undefined' && this.permission > 5) || ( typeof this.user.id != 'undefined' && match.stage==this.currentStage ) || (typeof this.user.id!='undefined' && this.currentStage==-1 && this.permission > 6) ){
					
						var that = this;
						that.result = {}
						// find the result in the results list
						that.results.forEach(function(result){
							if( typeof result.user == 'undefined'){ 
								if(result.id==match.id){
									that.result = result;
								}
							}
							else{
								if(result.match==match.id){
									that.result = result;
								}
							}
						});
						this.$.editScore.open();
					}
				}
				else{
					this.expandedStage = match.stage;
				}
			},
			saveScore: function(e){
				if(typeof this.user.id != 'undefined'){
					this.$.prono.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2});	
				}
				else{
					app.$.model.$.matchresultsModel.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2,'penalty1':e.detail.penalty1,'penalty2':e.detail.penalty2});
				}
			},
            showPenalties: function(user){
                return typeof user.id == 'undefined'
            },
			addSpacerAfter: function(stage,match){
				return ( (stage.id==8 && (match.position==1 || match.position==3)) || (stage.id==4 && match.position==1) );
			},
			addSpacerBefore: function(stage,match){
				return ( (stage.id==4 && match.position==2) );
			},
			stageClass: function(stage){
				return 'stage-'+stage.id;
			},
			disabledClass: function(stage,currentStage,user){
				if(currentStage==stage.id || currentStage==-1 || typeof user.id == 'undefined'){
					return '';
				}
				else{
					return 'disabled';
				}
			},
			isCollapsed: function(stage,expandedStage){
				return (stage.id != expandedStage);
			},
			collapsedClass: function(stage,expandedStage){
				if(this.isCollapsed(stage,expandedStage) && this.isSmall()){
					return 'collapsed';
				}
				else{
					return 'expanded';
				}
			},
			isTiny: function(){
				var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
				return (w<500);
			},
			isSmall: function(){
				var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
				return (w<1200);
			},
			isLow: function(){
				var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
				return (h<400);
			},
			hideTeamName: function(stage,expandedStage){
				return ( (this.isTiny() || this.isLow()) && this.isCollapsed(stage,expandedStage));
			},
			abreviateTeamName: function(stage,expandedStage){
				return (this.isSmall() && this.isCollapsed(stage,expandedStage));
			},
			iconLayoutClass: function(stage,expandedStage){
				if(this.isTiny()){
					return 'vertical';
				}
				else if(this.isSmall() && this.isCollapsed(stage,expandedStage)){
					return 'vertical';
				}
				else{
					return 'horizontal';
				}
			},
			scoreLayoutClass: function(stage,expandedStage){
				if(this.isTiny() && this.isCollapsed(stage,expandedStage)){
					return 'vertical';
				}
				else{
					return 'horizontal';
				}
			},
			expandStage: function(stage){
				this.expandedStage = stage;
			},
			_sortMatches: function(a, b) {  
  
				if(parseInt(a.date) > parseInt(b.date)){
					return 1;
				}
				else if(parseInt(a.date) < parseInt(b.date)){
					return -1;
				}
				else{
					return 0;
				}
			},
			trans: function(key){
				return app.trans(key,this.dictionary);
			}
		});
	</script>

</dom-module>
