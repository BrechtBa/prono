
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/prono-score-dialog/prono-score-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">

<dom-module id="prono-groupwinners">
	<template>

		<style>
			:host{
				display: block;
				width: 100%;
			}
			paper-button{
				background: var(--button-background-color);
				color: var(--button-text-color);
			}
			paper-button.primary{
				background: var(--button-background-primary-color);
				color: var(--button-text-primary-color);
			}
			.teamicon{
				width: 30px;
				height: 30px;
			}
			.teamname{
				padding-left: 20px;
			}
			h4{
				margin: 0;
			}
			.points{
				width: 50px;
			}
			#editPoints .points{
				margin-left: 10px;
			}
			#editPoints .points paper-number-input{
				margin-top: -16px;
			}
			.hidden{
				display: none;
			}
			.hidden{
				display: none;
			}
		</style>

		<api-model id="prono" token="{{token}}" url="http://pronoapi.duckdns.org/pronogroupstagewinners/" model="{{prono}}" on-change="handlePronoChange"></api-model>
		
		<template is="dom-if" if="{{isProno(user)}}">
			<div on-tap="editWinners">
				<div class="horizontal layout center">
					<div class="flex">{{trans('Winner')}}:</div>
					<prono-team-icon class="teamicon" team="{{getTeam(teamsModel,prono,1)}}"></prono-team-icon>
					<prono-team-name class="flex-2 teamname" team="{{getTeam(teamsModel,prono,1)}}" default=""></prono-team-name>
				</div>
				<div class="horizontal layout center">
					<div class="flex">{{trans('Runner up')}}:</div>
					<prono-team-icon class="teamicon" team="{{getTeam(teamsModel,prono,2)}}"></prono-team-icon>
					<prono-team-name class="flex-2 teamname" team="{{getTeam(teamsModel,prono,2)}}" default=""></prono-team-name>
				</div>
			</div>
		</template>


		<template is="dom-if" if="{{!isProno(user)}}">
			<h4>{{trans('Ranking')}}</h4>
			<div on-tap="editPoints">
				<template is="dom-repeat" items="{{teamsModel}}" as="team" filter="{{filterGroupTeams(group,matchesModel)}}" sort="_sortTeams">
					<div class="horizontal layout center">
						<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
						<prono-team-name class="flex-2 teamname" team="{{team}}" default=""></prono-team-name>
						<div class="points">{{roundPoints(team.groupstage_points)}}</div>
					</div>
				</template>
			</div>
		</template>




		<default-dialog id="editWinners">
			<form is="iron-form" id="formProno" on-iron-form-submit="saveProno" action="/">
				<div>
					<paper-dropdown-menu label="{{trans('Winner')}}">
						<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{winner}}">
							<paper-item value="0"></paper-item>
							<template is="dom-repeat" items="{{teamsModel}}" as="team" filter="{{filterGroupTeams(group,matchesModel)}}">
								<paper-item value="{{team.id}}">{{team.name}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>

					<paper-dropdown-menu label="{{trans('Runner up')}}">
						<paper-menu class="dropdown-content" attr-for-selected="value" selected="{{runnerup}}">
							<paper-item value="0"></paper-item>
							<template is="dom-repeat" items="{{teamsModel}}" as="team" filter="{{filterGroupTeams(group,matchesModel)}}">
								<paper-item value="{{team.id}}">{{team.name}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>
				</div>
				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmitProno">{{trans('Save')}}</paper-button>
					<button type="submit" class="hidden">{{trans('Save')}}</button>
				</div>
			</form>
		</default-dialog>




		<default-dialog id="editPoints">
			<form is="iron-form" id="formRanking" on-iron-form-submit="saveRanking" action="/">
				<div>
					<template is="dom-repeat" items="{{newTeams}}" as="team" sort="_sortTeams">
						<div class="horizontal layout center">
							<prono-team-icon class="teamicon" team="{{team}}"></prono-team-icon>
							<prono-team-name class="flex-2 teamname" team="{{team}}" default=""></prono-team-name>
							<div class="points"><paper-number-input label="" auto-validate pattern="[0-9.]*" error-message="x" value={{team.groupstage_points}}></paper-input></div>
						</div>
					</template>
				</div>
				<div class="buttons">
					<paper-button raised class="primary" on-tap="formSubmitRanking">Save</paper-button>
					<button type="submit" class="hidden">Save</button>
				</div>
			</form>
		</default-dialog>



	</template>

	<script>
		Polymer({
			is: 'prono-groupwinners',
			properties: {
				token: {
					type: 'String',
					value: ''
				},
				permission: {
					type: 'Number',
					value: 1
				},
				teamsModel: {
					type: 'Array',
				},
				matchesModel: {
					type: 'Array',
				},
				group: {
					type: 'Object'
				},
				currentStage:{
					type: 'Number',
					value: 1
				},
				user: {
					type: 'Object',
					value: {}
				},
				databasePrepared: {
					type: 'Number',
				},
			},
			observers:[
				'getProno(token,user,group,databasePrepared)',
			],
			created: function(){
				// create the local dictionary
				this.dictionary = {};
				this.dictionary['Winner'] = {'nl':'Winnaar'};
				this.dictionary['Runner up'] = {'nl':'Tweede'};
			},
			ready: function(){
				console.log('ready');
				var that = this;
				document.addEventListener('clear-prono', function(e){
					that.prono = [];
				});
			},
			getProno: function(token,user,group,databasePrepared){
				if(databasePrepared!=1 || typeof user.id == 'undefined' || typeof group.id == 'undefined'  || token == ''){
					this.prono = [];
				}
				else{
					this.$.prono.get('?user='+user.id+'&group='+group.id);
				}
			},
			handlePronoChange: function(e){
				console.log('test')
				console.log(this.prono)
			},
			isProno: function(user){
				return (typeof user.id != 'undefined');
			},
			getTeam: function(teamsModel,prono,ranking){
				var team = {};
				try{
					var id = -1;
					prono.forEach(function(item){
						if(item.ranking == ranking){					
							id = item.team;
						}
					});
					teamsModel.forEach(function(item){
						if(item.id == id){					
							team = item;
						}
					});
				}
				catch(e){
				}
				return team;
			},
			editWinners: function(){
				winner = this.getTeam(this.teamsModel,this.prono,1);
				if( winner != {} ){
					this.winner = winner.id;
				}

				runnerup = this.getTeam(this.teamsModel,this.prono,2);
				if( runnerup != {} ){
					this.runnerup = runnerup.id;
				}

				this.$.editWinners.open();
			},
			filterGroupTeams: function(group,matchesModel){
				// find the matches in the group
				try{			
					var matches = matchesModel.filter(function( match ){
						return ( match.group == group.id );
					});
				}
				catch(e){
					var matches = [];
				}
				var team_ids = [];
				matches.forEach(function(match){
					if(team_ids.indexOf(match.team1) == -1){
						team_ids.push( match.team1 );
					}
					if(team_ids.indexOf(match.team2) == -1){
						team_ids.push( match.team2 );
					}
				});

				return function(item){
					return ( team_ids.indexOf(item.id) > -1 );
			  	};
			},
			formSubmitProno: function(){
				this.$.formProno.submit();
			},
			saveProno: function(){
				this.$.editWinners.close();

				var winner_prono_id = -1; 
				var runnerup_prono_id = -1; 
				this.prono.forEach(function(item){
					if(item.ranking == 1){					
						winner_prono_id = item.id;
					}
					if(item.ranking == 2){					
						runnerup_prono_id  = item.id;
					}
				});
				var winner = null
				if(this.winner > 0){
					winner = this.winner;
				}
				var runnerup = null
				if(this.runnerup > 0){
					runnerup = this.runnerup;
				}
			
				this.$.prono.put(winner_prono_id+'/',{'team': winner});
				this.$.prono.put(runnerup_prono_id+'/',{'team': runnerup});
			},
			roundPoints: function(points){
				return Math.floor(parseFloat(points));
			},
			editPoints: function(){
				var that = this;
				if(that.permission > 5){ 
					var newTeams = [];
					filter = that.filterGroupTeams(that.group,that.matchesModel);
					that.teamsModel.forEach(function(team){
						if( filter(team) ){
							newTeams.push(team);
						}
					});
					that.newTeams = newTeams;
					that.$.editPoints.open();

					// bug in polymer, manually center dynamically populated dialogs issue # 68
					that.async(function() {
		            	that.$.editPoints.center();
		          	});
				}
			},
			formSubmitRanking: function(){
				console.log('submit')
				this.$.formRanking.submit();
			},
			saveRanking: function(){
				this.$.editPoints.close();

				this.newTeams.forEach( function(team){
					app.$.model.$.teamsModel.put(team.id+'/',{'groupstage_points': team.groupstage_points})
				});
			},
			handlePronoChange: function(){
			},
			_sortTeams: function(a, b) {  
  
				if(parseFloat(a.groupstage_points) > parseFloat(b.groupstage_points)){
					return -1;
				}
				else if(parseFloat(a.groupstage_points) < parseFloat(b.groupstage_points)){
					return 1;
				}
				else{
					return 0;
				}
			},
			trans: function(key){
				return app.trans(key,this.dictionary);
			}
		});
	</script>

</dom-module>
