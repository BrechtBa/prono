
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>

		<api-model id="usersModel"        token="[[token]]" url="http://pronoapi.duckdns.org/userprofiles/" model="{{usersModel}}"        on-change="handleUsersModelChange"></api-model>
		<!--<api-model id="rulesModel" token="[[token]]" url="../../api/index.php/rules" model="{{rulesModel}}" on-change="handleRulesModelChange"></api-model>-->	
		<api-model id="groupsModel"       token="[[token]]" url="http://pronoapi.duckdns.org/groups/"       model="{{groupsModel}}"       on-change="handleGroupsModelChange"></api-model>
		<api-model id="teamsModel"        token="[[token]]" url="http://pronoapi.duckdns.org/teams/"        model="{{teamsModel}}"        on-change="handleTeamsModelChange"></api-model>
		<api-model id="matchesModel"      token="[[token]]" url="http://pronoapi.duckdns.org/matches/"      model="{{matchesModel}}"      on-change="handleMatchesModelChange"></api-model>
		<api-model id="matchresultsModel" token="[[token]]" url="http://pronoapi.duckdns.org/matchresults/" model="{{matchresultsModel}}" on-change="handleMatchresultsModelChange"></api-model>
		
		<!--<api-model id="checkUpdateModel" token="[[token]]" url="../../api/index.php/last_update" model="{{updateModel}}" on-change="handleCheckUpdateChange"></api-model>-->

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
				},
				rulesModel: {
					type: 'Array',
					notify: true
				},
				usersModel: {
					type: 'Array',
					notify: true
				},
				groupsModel: {
					type: 'Array',
					notify: true
				},
				teamsModel: {
					type: 'Array',
					notify: true
				},
				matchesModel: {
					type: 'Array',
					notify: true
				},
				matchresultsModel: {
					type: 'Array',
					notify: true
				},
				pronoScoreModel: {
					type: 'Array',
					notify: true
				},
				pronoTeamModel: {
					type: 'Array',
					notify: true
				},
				allPronoScoreModel: {
					type: 'Array',
					notify: false
				},
				stagesModel: {
					type: 'Array',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true,
					value: {}
				},
				last_update: {
					type: 'Number',
					value: 0
				}
			},
			listeners: {
			},
			observers: [
				'tokenChanged(token)',
			],
			ready: function(){
			},
			tokenChanged: function(){
				console.log('token changed');	
				try{
					this.user = {'id':this.tokenPayload.user_id,'username':this.tokenPayload.username};
				}
				catch(e){
					this.user = {};
				}

				this.$.usersModel.get();
				this.$.groupsModel.get();
				this.$.teamsModel.get();
				this.$.matchesModel.get();
				this.$.matchresultsModel.get();	
			},
			handleUsersModelChange: function(e){
			},
			handleRulesModelChange: function(){
			},
			handleGroupsModelChange: function(){
			},
			handleTeamsModelChange: function(){
			},
			handleMatchesModelChange: function(){
				console.log('get stages');
				var stages = [];
				this.matchesModel.forEach(function(match){
					if(match.stage > 0 && stages.indexOf(match.stage)==-1){
						stages.push(match.stage);
					}
				});
				this.stagesModel = stages;
			},
			handleMatchresultsModelChange: function(){
				this.last_update = Math.floor( new Date().getTime()/1000 );
				this.fire('prono-model-changed');
			},
			handleCheckUpdateChange: function(){
				console.log('check if update is required')
				if( this.updateModel.length > 0 ){
					if( parseInt(this.updateModel[0]['time']) > this.last_update){
						console.log('update');
						this.last_update = this.updateModel[0]['time'];
						this.$.usersModel.get();
					}
				}
			}
		});
	</script>

</dom-module>
