
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>
		<iron-ajax id="checkUser" url="http://pronoapi.duckdns.org/checkuser/" method="POST" content-type="application/json" handle-as="json" on-response="handleCheckUserResponse" last-response="{{checkUserResponse}}" debounce-duration="300"></iron-ajax>

		<api-model id="usersModel"        token="[[token]]" url="http://pronoapi.duckdns.org/userprofiles/" model="{{usersModel}}"        on-change="handleUsersModelChange"></api-model>
		<!--<api-model id="rulesModel" token="[[token]]" url="../../api/index.php/rules" model="{{rulesModel}}" on-change="handleRulesModelChange"></api-model>-->	
		<api-model id="groupsModel"       token="[[token]]" url="http://pronoapi.duckdns.org/groups/"       model="{{groupsModel}}"       on-change="handleGroupsModelChange"></api-model>
		<api-model id="teamsModel"        token="[[token]]" url="http://pronoapi.duckdns.org/teams/"        model="{{teamsModel}}"        on-change="handleTeamsModelChange"></api-model>
		<api-model id="matchesModel"      token="[[token]]" url="http://pronoapi.duckdns.org/matches/"      model="{{matchesModel}}"      on-change="handleMatchesModelChange"></api-model>
		<api-model id="matchresultsModel" token="[[token]]" url="http://pronoapi.duckdns.org/matchresults/" model="{{matchresultsModel}}" on-change="handleMatchresultsModelChange"></api-model>
		
		<api-model id="lastUpdateModel" token="[[token]]" url="http://pronoapi.duckdns.org/lastupdate/" model="{{lastUpdateModel}}" on-change="handleLastUpdateModelChange"></api-model>

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
				},
				rulesModel: {
					type: 'Array',
					notify: true
				},
				usersModel: {
					type: 'Array',
					notify: true
				},
				groupsModel: {
					type: 'Array',
					notify: true
				},
				teamsModel: {
					type: 'Array',
					notify: true
				},
				matchesModel: {
					type: 'Array',
					notify: true
				},
				matchresultsModel: {
					type: 'Array',
					notify: true
				},
				pronoScoreModel: {
					type: 'Array',
					notify: true
				},
				pronoTeamModel: {
					type: 'Array',
					notify: true
				},
				allPronoScoreModel: {
					type: 'Array',
					notify: false
				},
				stagesModel: {
					type: 'Array',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true,
					value: {}
				},
				lastUpdate: {
					type: 'Number',
					value: 0
				}
			},
			listeners: {
			},
			observers: [
				'tokenChanged(token)',
			],
			ready: function(){
			},
			tokenChanged: function(){
				console.log('token changed');	
				try{
					this.user = {'id':this.tokenPayload.user_id,'username':this.tokenPayload.username};

					// send a request to fill in the user database entries
					if(this.token != ''){
						console.log('check user')
						this.$.checkUser.headers['Authorization']   = 'JWT '+this.token;
						this.$.checkUser.body = '{}';
						this.$.checkUser.generateRequest();

						this.$.usersModel.get();
						this.$.groupsModel.get();
						this.$.teamsModel.get();
						this.$.matchesModel.get();
						this.$.matchresultsModel.get();
					}
				}
				catch(e){
					// token is not valid
					this.user = {};
					this.usersModel = [];

					clearInterval(window.updateCheckInterval);
				}
			},
			handleCheckUserResponse: function(e){
				console.log(e)
				console.log(this.checkUserResponse)

				this.$.usersModel.get();

				this.lastUpdate = Math.floor( new Date().getTime()/1000 );

				var that = this;
				clearInterval(window.updateCheckInterval);
				window.updateCheckInterval = window.setInterval(function(){
					that.$.lastUpdateModel.get();
				}, 30000);

			},
			handleUsersModelChange: function(e){
			},
			handleRulesModelChange: function(){
			},
			handleGroupsModelChange: function(){
			},
			handleTeamsModelChange: function(){
			},
			handleMatchesModelChange: function(){
				console.log('get stages');
				var stages = [];
				var stagesFound = [];
				this.matchesModel.forEach(function(match){
					if(match.stage === 0 && stagesFound.indexOf(match.stage)==-1){
						stagesFound.push(match.stage);
						stages.push({'id':0, 'type':'groupstage', 'numberofteams':0})
					}
					if(match.stage > 0 && stagesFound.indexOf(match.stage)==-1){
						stagesFound.push(match.stage);
						stages.push({'id':match.stage, 'type':'knockoutstage', 'numberofteams':match.stage})
					}
				});
				this.stagesModel = stages;
			},
			handleMatchresultsModelChange: function(){
				
				this.fire('prono-model-changed');
			},
			handleLastUpdateModelChange: function(){
				console.log('check if update is required')
				if( this.lastUpdateModel.length > 0 ){
					if( parseInt(this.lastUpdateModel[0]['date']) > this.lastUpdate){
						console.log('update');
						this.lastUpdate = this.lastUpdateModel[0]['date'];

						this.$.teamsModel.get();
						this.$.matchesModel.get();
						this.$.matchresultsModel.get();

						this.fire('update')
					}
				}
			}
		});
	</script>

</dom-module>
