
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/api-model/api-model.html">

<dom-module id="prono-model">
	<template>

		<style>
		</style>

		<parse-token token="{{token}}" payload="{{tokenPayload}}"></parse-token>
		<iron-ajax id="prepareDatabaseForUser" url="http://pronoapi.duckdns.org/preparedatabaseforuser/" method="POST" content-type="application/json" handle-as="json" on-response="handlePrepareDatabaseForUserResponse" last-response="{{prepareDatabaseForUserResponse}}" debounce-duration="300"></iron-ajax>
		<iron-ajax id="calculatePoints"        url="http://pronoapi.duckdns.org/calculatepoints/"        method="POST" content-type="application/json" handle-as="json" on-response="handleCalculatePointsResponse"        last-response="{{calculatePointsResponse}}"        debounce-duration="300"></iron-ajax>
		
		
		<api-model id="userStatus"        token="[[token]]" url="http://pronoapi.duckdns.org/userstatus/" model="{{userStatusModel}}"     on-change="handleUserStatusModelChange"></api-model>
		<api-model id="usersModel"        token="[[token]]" url="http://pronoapi.duckdns.org/userprofiles/" model="{{usersModel}}"        on-change="handleUsersModelChange"></api-model>
		<!--<api-model id="rulesModel" token="[[token]]" url="../../api/index.php/rules" model="{{rulesModel}}" on-change="handleRulesModelChange"></api-model>-->	
		<api-model id="groupsModel"       token="[[token]]" url="http://pronoapi.duckdns.org/groups/"       model="{{groupsModel}}"       on-change="handleGroupsModelChange"></api-model>
		<api-model id="teamsModel"        token="[[token]]" url="http://pronoapi.duckdns.org/teams/"        model="{{teamsModel}}"        on-change="handleTeamsModelChange"></api-model>
		<api-model id="matchesModel"      token="[[token]]" url="http://pronoapi.duckdns.org/matches/"      model="{{matchesModel}}"      on-change="handleMatchesModelChange"></api-model>
		<api-model id="matchresultsModel" token="[[token]]" url="http://pronoapi.duckdns.org/matchresults/" model="{{matchresultsModel}}" on-change="handleMatchresultsModelChange"></api-model>
		
		<api-model id="lastUpdateModel" token="[[token]]" url="http://pronoapi.duckdns.org/lastupdate/" model="{{lastUpdateModel}}" on-change="handleLastUpdateModelChange"></api-model>

	</template>

	<script>
		Polymer({
			is: 'prono-model',
			properties: {
				token: {
					type: 'String',
					value: '',
				},
				rulesModel: {
					type: 'Array',
					notify: true
				},
				usersModel: {
					type: 'Array',
					notify: true
				},
				groupsModel: {
					type: 'Array',
					notify: true
				},
				teamsModel: {
					type: 'Array',
					notify: true
				},
				matchesModel: {
					type: 'Array',
					notify: true
				},
				matchresultsModel: {
					type: 'Array',
					notify: true
				},
				pronoScoreModel: {
					type: 'Array',
					notify: true
				},
				pronoTeamModel: {
					type: 'Array',
					notify: true
				},
				allPronoScoreModel: {
					type: 'Array',
					notify: false
				},
				stagesModel: {
					type: 'Array',
					notify: true
				},
				user: {
					type: 'Object',
					notify: true,
					value: {}
				},
				databasePrepared: {
					type: 'Number',
					notify: true
				},
				lastUpdate: {
					type: 'Array',
					value: []
				}
			},
			listeners: {
			},
			observers: [
				'tokenPayloadChanged(tokenPayload)',
			],
			ready: function(){
			},
			tokenPayloadChanged: function(){
				console.log('token payload changed');
				if( typeof this.tokenPayload['user_id'] != 'undefined' ){
					this.user = {'id':this.tokenPayload.user_id,'username':this.tokenPayload.username};

					// check the user status
					this.$.userStatus.get('?user='+this.user['id']);
					
					// get users model
					this.$.usersModel.get();
					
					// get the competition models
					this.$.groupsModel.get();
					this.$.teamsModel.get();
					this.$.matchesModel.get();
					this.$.matchresultsModel.get();
					
					this.setLastUpdate();
				}
				else{
					// token is not valid
					this.user = {};
					this.usersModel = [];
					this.databasePrepared = 0;

					this.fire('clear-prono');
					clearInterval(window.updateCheckInterval);
				}
				
			},
			handleUserStatusModelChange: function(e){
				if( this.userStatusModel.length > 0){
					if(!this.userStatusModel[0]['databaseprepared']){
						console.log('prepare the database for the user')
						this.$.prepareDatabaseForUser.headers['Authorization']   = 'JWT '+this.token;
						this.$.prepareDatabaseForUser.body = '{}';
						this.$.prepareDatabaseForUser.generateRequest();
					}
					else{
						console.log('test')
						// prono database is ready for the user
						this.databasePrepared = 1;
						console.log(this.databasePrepared)
					}
				}
			},
			handlePrepareDatabaseForUserResponse: function(e){
				this.$.userStatus.get('?user='+this.user['id']);
			},
			handleUsersModelChange: function(e){
			},
			handleRulesModelChange: function(e){
			},
			handleGroupsModelChange: function(e){
			},
			handleTeamsModelChange: function(e){
				this.$.lastUpdateModel.get();
			},
			handleMatchesModelChange: function(e){
				console.log('get stages');
				var stages = [];
				var stagesFound = [];
				this.matchesModel.forEach(function(match){
					if(match.stage === 0 && stagesFound.indexOf(match.stage)==-1){
						stagesFound.push(match.stage);
						stages.push({'id':0, 'type':'groupstage', 'numberofteams':0})
					}
					if(match.stage > 0 && stagesFound.indexOf(match.stage)==-1){
						stagesFound.push(match.stage);
						stages.push({'id':match.stage, 'type':'knockoutstage', 'numberofteams':match.stage})
					}
				});
				this.stagesModel = stages;
				this.$.lastUpdateModel.get();
			},
			handleMatchresultsModelChange: function(e){
				this.$.lastUpdateModel.get();
			},
			handleLastUpdateModelChange: function(e){
				console.log('check if update is required')
				if( this.lastUpdateModel.length > 1 ){
					if( parseInt(this.lastUpdateModel[0]['date']) > this.lastUpdate[0] ){
						console.log('update points')
						this.lastUpdate[0] = this.lastUpdateModel[0]['date'];
						
						this.fire('update-points')
					}
					if( parseInt(this.lastUpdateModel[1]['date']) > this.lastUpdate[1] ){
						console.log('update competition')
						this.lastUpdate[1] = this.lastUpdateModel[1]['date'];

						this.fire('update-competition')
						this.$.teamsModel.get();
						this.$.matchesModel.get();
						this.$.matchresultsModel.get();

						this.calculatePoints();
					}
				}
			},
			handleCalculatePointsResponse: function(){
				console.log('points calculated')
			},
			calculatePoints: function(){
				if( typeof this.tokenPayload != 'undefined' ){
					if(this.tokenPayload['permission']>5){
						console.log('calculate points')
						this.$.calculatePoints.headers['Authorization']   = 'JWT '+this.token;
						this.$.calculatePoints.body = '{}';
						this.$.calculatePoints.generateRequest();
					}
				}
			},
			setLastUpdate: function(){
				this.lastUpdate[0] = Math.floor( new Date().getTime()/1000 );
				this.lastUpdate[1] = Math.floor( new Date().getTime()/1000 );
				var that = this;
				clearInterval(window.updateCheckInterval);
				window.updateCheckInterval = window.setInterval(function(){
					that.$.lastUpdateModel.get();
				}, 30000);
			},
		});
	</script>

</dom-module>
