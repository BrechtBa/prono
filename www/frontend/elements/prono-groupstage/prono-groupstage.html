
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">

<link rel="import" href="../../elements/parse-token/parse-token.html">
<link rel="import" href="../../elements/prono-score-dialog/prono-score-dialog.html">
<link rel="import" href="../../elements/prono-team-name/prono-team-name.html">
<link rel="import" href="../../elements/prono-team-icon/prono-team-icon.html">
<link rel="import" href="../../elements/prono-groupwinners/prono-groupwinners.html">
<link rel="import" href="../../elements/prono-check/prono-check.html">

<dom-module id="prono-groupstage">
    <template>

        <style>
            :host{
                display: block;
                width: 100%;
            }
            paper-material{
                  margin: 5px;
                cursor: pointer;
                padding: 10px;
                background: var(--background-secondary-color);
                color: var(--text-secondary-color);
                border-radius: 2px;
            }
            paper-material.group{
                width: 100%;
                max-width: 360px;
            }
            .disabled .group::after{
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(1,1,1,0.3);
                border-radius: 2px;
            }
            paper-material h3{
                margin-top: 0px;
            }
            .score{
                width: 60px;
                text-align: center;
            }
            .teamicon{
                width: 30px;
                height: 30px;
            }
            .teamname.left{
                text-align: left;
            }
            .teamname.right{
                text-align: right;
            }
            prono-groupwinners{
                margin-top: 20px;
            }
            prono-groupranking{
                margin-top: 20px;
            }
        </style>

        <api-model id="prono" token="{{token}}" url="http://pronoapi.duckdns.org/pronoresults/" model="{{prono}}"></api-model>
        
        
        <prono-check status="{{groupstageResultsStatus}}" prono="[[filterGroupstageProno(prono,matchesModel)]]" date="[[tokenPayload.access_exp]]" condition="(prono.score1>-1 && prono.score2>-1 && prono.score1!= null && prono.score2!= null)" pass-message="" fail-message=""></prono-check>
        <template is="dom-if" if="{{_displayStatus(prono)}}">
            <prono-check status="{{computePronoStatus(groupstageResultsStatus,groupwinnersStatus)}}" date="[[tokenPayload.access_exp]]" ></prono-check>
        </template>

        <div class$="{{disabledClass(currentStage,user)}} horizontal layout wrap center-justified">
            
            <template is="dom-repeat" items="{{groupsModel}}" as="group">
                <paper-material elevation="2" class="group vertical layout">
                    <h3>{{trans('Group')}} {{group.name}}</h3>
                    <div class="matches">    
                        <template is="dom-repeat" items="{{matchesModel}}" as="match" filter="{{filterGroupMatches(group)}}">
                            <div class="match horizontal layout center center-justified" on-tap="editScore">
                                <div class="teamname left flex"><prono-team-name team="{{getTeam(match.team1,teamsModel)}}" default="{{match.defaultteam1}}"></prono-team-name></div>
                                <div><prono-team-icon class="teamicon" team="{{getTeam(match.team1,teamsModel)}}"></prono-team-icon></div>
                                <div class="score">{{getScore1(match,results)}} - {{getScore2(match,results)}}</div>
                                <div><prono-team-icon class="teamicon" team="{{getTeam(match.team2,teamsModel)}}"></prono-team-icon></div>
                                <div class="teamname right flex"><prono-team-name team="{{getTeam(match.team2,teamsModel)}}" default="{{match.defaultteam2}}"></prono-team-name></div>
                            </div>
                        </template>
                    </div>
                    
                    <prono-groupwinners token="{{token}}" status="{{group.status}}" on-status-changed="groupwinnerStatusChanged" permission="{{permission}}" database-prepared="{{databasePrepared}}" teams-model="{{teamsModel}}" matches-model="{{matchesModel}}" group="{{group}}" user="{{user}}"></prono-groupwinners>

                </paper-material>
            </template>

        </div>

        <prono-score-dialog id="editScore" teams-model="{{teamsModel}}" matches-model="{{matchesModel}}" result="{{result}}" on-save="saveScore"></prono-score-dialog>
    </template>

    <script>
        Polymer({
            is: 'prono-groupstage',
            properties: {
                token:{
                    type: 'String',
                    value: ''
                },
                permission: {
                    type: 'Number',
                    value: 1
                },
                tokenPayload: {
                    type: 'Object'
                },
                groupsModel: {
                    type: 'Array'
                },
                teamsModel: {
                    type: 'Array'
                },
                matchesModel: {
                    type: 'Array',
                },
                matchresultsModel: {
                    type: 'Array',
                },
                currentStage:{
                    type: 'Number',
                    value: 1
                },
                user: {
                    type: 'Object',
                    value: {}
                },
                databasePrepared: {
                    type: 'Number',
                },
                groupwinnersStatus: {
                    type: 'Array',
                    value: [],
                },
            },
            observers:[
                'getProno(token,user,databasePrepared)',
                'getResults(user,matchresultsModel,prono)'
            ],
            created: function(){
                // create the local dictionary
                this.dictionary = {};
                this.dictionary['Group'] = {'nl':'Groep'};
            },
            ready: function(){
                console.log('ready');
                var that = this;
                document.addEventListener('clear-prono', function(e){
                    that.prono = [];
                });
            },
            getProno: function(token,user,databasePrepared){
                console.log('get groupstage prono')
                if(databasePrepared!=1 || typeof user.id == 'undefined' || token == '' ){
                    this.prono = [];
                }
                else{
                    this.$.prono.get('?user='+user.id);
                }
            },
            getResults: function(user,matchresultsModel,prono){
                if(typeof user.id != 'undefined'){
                    this.results = this.prono.filter(function(prono){
                        return (prono.user == user.id);
                    });
                }
                else{
                    this.results = matchresultsModel;
                }
            },
            editScore: function(e){
                var match = e.model.__data__.match;
                if( (typeof this.user.id == 'undefined' && this.permission > 5) || ( typeof this.user.id != 'undefined' && match.stage==this.currentStage ) || (typeof this.user.id!='undefined' && this.currentStage==-1 && this.permission > 6)  ){
                    
                    var that = this;
                    that.result = {}
                    // find the result in the results list
                    that.results.forEach(function(result){
                        if( typeof result.user == 'undefined'){ 
                            if(result.id==match.id){
                                that.result = result;
                            }
                        }
                        else{
                            if(result.match==match.id){
                                that.result = result;
                            }
                        }
                    });
                    this.$.editScore.open();
                }
            },
            saveScore: function(e){
                if(typeof this.user.id != 'undefined'){
                    this.$.prono.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2});    
                }
                else{
                    app.$.model.$.matchresultsModel.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2});
                }
            },
            filterGroupMatches: function(group){
                return function(item){
                    return (item.group == group.id);
                  };
            },
            filterGroupstageProno: function(prono,matchesModel){

                var matchids = [];
                matchesModel.forEach(function(m){
                    if(m.stage==0){
                        matchids.push(m.id)
                    }
                });

                return prono.filter(function(p){
                    return (p.match in matchids);
                });
            },
            disabledClass: function(currentStage,user){
                if(currentStage==0 || currentStage==-1 || typeof user.id == 'undefined'){
                    return '';
                }
                else{
                    return 'disabled';
                }
            },
            getTeam: function(id,teams){
                var team = {};
                teams.forEach(function(item){
                    if(item.id == id){
                        team = item;
                    }
                });
                return team;
            },
            getScore1: function(match,results){
                var score = -1;
                results.forEach(function(item){
                    if(item.match == match.id){
                        score = item.score1
                    }
                });
                return this.formatScore(score);
            },
            getScore2: function(match,results){
                var score = -1;
                results.forEach(function(item){
                    if(item.match == match.id){
                        score = item.score2
                    }
                });
                return this.formatScore(score)
            },
            formatScore: function(score){
                var val = '';
                if(score<0){
                    val = '';
                }
                else{
                    val = score;
                }
                return val;
            },
            handlePronoChange: function(){

            },
            groupwinnerStatusChanged: function(e){
                var tempstatus = [];
                this.groupsModel.forEach(function(group){
                    tempstatus.push(group.status);
                });

                this.groupwinnersStatus = tempstatus;
            },
            computePronoStatus: function(groupstageResultsStatus,groupwinnersStatus){
                var status = groupstageResultsStatus;

                groupwinnersStatus.forEach(function(s){
                    if(s==0){
                        status = 0;
                    }
                });
                return status;
            },
            _displayStatus: function(prono){
                return prono.length!=0;
            },
            _sortMatches: function(a, b) {  
  
                if(parseInt(a.date) > parseInt(b.date)){
                    return 1;
                }
                else if(parseInt(a.date) < parseInt(b.date)){
                    return -1;
                }
                else{
                    return 0;
                }
            },
            trans: function(key){
                return app.trans(key,this.dictionary);
            },
            formatDate: function(timestamp){
                var date = new Date(timestamp * 1000);
                var day = date.getDate();
                var month = (date.getMonth()+1)
                var year = date.getFullYear();
                var hours = date.getHours();
                var minutes = date.getMinutes();
                return (day < 10? '0' : '') + day + '-' + (month < 10? '0' : '') + month + '-' + date.getFullYear() + ' ' + (hours < 10? '0' : '') + hours + ':' +  (minutes < 10? '0' : '') + minutes;
            },
        });
    </script>

</dom-module>
