<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="prono-match.html">
<link rel="import" href="prono-groupwinners.html">

<dom-module id="prono-groupstage">
    <template>
        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host{
                display: block;
                width: 100%;
            }
            paper-material{
                margin: 5px;
                cursor: pointer;
                padding: 10px;
                background: var(--background-secondary-color);
                color: var(--primary-text-color);
                border-radius: 2px;
            }
            paper-material.group{
                width: 100%;
                max-width: 360px;
            }
            .disabled .group::after{
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(1,1,1,0.3);
                border-radius: 2px;
            }
            .group h3{
                margin-top: 0px;
            }
            prono-groupwinners{
                margin-top: 20px;
            }
            prono-groupranking{
                margin-top: 20px;
            }
        </style>

        <firebase-query id="query" app-name="prono" path="/[[pronoGroupId]]/competition/stages/groupstage" data="{{groups}}"></firebase-query>

        <div class$="{{_disabledClass()}} horizontal layout wrap center-justified">
            
            <template is="dom-repeat" items="{{groups}}" as="group">
                <paper-material elevation="2" class="group vertical layout">
                    <h3>{{localize('groupname', 'group', group.$key)}}</h3>
                    <div class="matches">    
                        <template is="dom-repeat" items="{{group.matches}}" as="match" sort="_sortMatches">
                            <prono-match prono-group-id="[[pronoGroupId]]" match-id="{{match}}" stage="groupstage" permission="[[permission]]"></prono-match>
                        </template>
                    </div>

                    <prono-groupwinners prono-group-id="[[pronoGroupId]]" group="{{group}}"></prono-groupwinners>

                </paper-material>
            </template>

        </div>


    </template>

    <script>
        class PronoGroupstage extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element){
            static get is() { return 'prono-groupstage'; }

            static get properties() {
                return {
                    pronoGroupId: {
                        type: String,
                    },
                    language: {
                        value: 'nl-BE',
                    },
                    resources: {
                        value() {
                            return {
                                'en': { 'groupname': 'Group {group}' },
                                'nl-BE': { 'groupname': 'Groep {group}' }
                            }
                        }
                    },
                };
            }

            _sortMatches(a, b) {
                return parseInt(a.date) - parseInt(b.date);
            }

            _disabledClass(currentStage,user){
                return '';
                if(currentStage==0 || currentStage==-1 || typeof user.id == 'undefined'){
                    return '';
                }
                else{
                    return 'disabled';
                }
            }

        }

        window.customElements.define(PronoGroupstage.is, PronoGroupstage);


        /*
        Polymer({
            is: 'prono-groupstage',
            properties: {
                token:{
                    type: 'String',
                    value: ''
                },
                permission: {
                    type: 'Number',
                    value: 1
                },
                tokenPayload: {
                    type: 'Object'
                },
                groupsModel: {
                    type: 'Array'
                },
                teamsModel: {
                    type: 'Array'
                },
                matchesModel: {
                    type: 'Array',
                },
                matchresultsModel: {
                    type: 'Array',
                },
                currentStage:{
                    type: 'Number',
                    value: 1
                },
                user: {
                    type: 'Object',
                    value: {}
                },
                databasePrepared: {
                    type: 'Number',
                },
                groupwinnersStatus: {
                    type: 'Array',
                    value: [],
                },
            },
            observers:[
                'getProno(token,user,databasePrepared)',
                'getResults(user,matchresultsModel,prono)'
            ],
            created: function(){
                // create the local dictionary
                this.dictionary = {};
                this.dictionary['Group'] = {'nl':'Groep'};
            },
            ready: function(){
                console.log('ready');
                var that = this;
                document.addEventListener('clear-prono', function(e){
                    that.prono = [];
                });
            },
            getProno: function(token,user,databasePrepared){
                console.log('get groupstage prono')
                if(databasePrepared!=1 || typeof user.id == 'undefined' || token == '' ){
                    this.prono = [];
                }
                else{
                    this.$.prono.get('?user='+user.id);
                }
            },
            getResults: function(user,matchresultsModel,prono){
                if(typeof user.id != 'undefined'){
                    this.results = this.prono.filter(function(prono){
                        return (prono.user == user.id);
                    });
                }
                else{
                    this.results = matchresultsModel;
                }
            },
            editScore: function(e){
                var match = e.model.__data__.match;
                if( (typeof this.user.id == 'undefined' && this.permission > 5) || ( typeof this.user.id != 'undefined' && match.stage==this.currentStage ) || (typeof this.user.id!='undefined' && this.currentStage==-1 && this.permission > 6)  ){
                    
                    var that = this;
                    that.result = {}
                    // find the result in the results list
                    that.results.forEach(function(result){
                        if( typeof result.user == 'undefined'){ 
                            if(result.id==match.id){
                                that.result = result;
                            }
                        }
                        else{
                            if(result.match==match.id){
                                that.result = result;
                            }
                        }
                    });
                    this.$.editScore.open();
                }
            },
            saveScore: function(e){
                if(typeof this.user.id != 'undefined'){
                    this.$.prono.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2});    
                }
                else{
                    app.$.model.$.matchresultsModel.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2});
                }
            },

            handlePronoChange: function(){

            },

            groupwinnerStatusChanged: function(e){
                var tempstatus = [];
                this.groupsModel.forEach(function(group){
                    tempstatus.push(group.status);
                });

                this.groupwinnersStatus = tempstatus;
            },
            computePronoStatus: function(groupstageResultsStatus,groupwinnersStatus){
                var status = groupstageResultsStatus;

                groupwinnersStatus.forEach(function(s){
                    if(s==0){
                        status = 0;
                    }
                });
                return status;
            },
            _displayStatus: function(prono){
                return prono.length!=0;
            },

            trans: function(key){
                return app.trans(key,this.dictionary);
            },
            formatDate: function(timestamp){
                var date = new Date(timestamp * 1000);
                var day = date.getDate();
                var month = (date.getMonth()+1)
                var year = date.getFullYear();
                var hours = date.getHours();
                var minutes = date.getMinutes();
                return (day < 10? '0' : '') + day + '-' + (month < 10? '0' : '') + month + '-' + date.getFullYear() + ' ' + (hours < 10? '0' : '') + hours + ':' +  (minutes < 10? '0' : '') + minutes;
            },
        });
        */
    </script>

</dom-module>
