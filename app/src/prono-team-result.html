<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">


<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="team-name.html">
<link rel="import" href="team-icon.html">


<dom-module id="prono-team-result">
    <template>
        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host{
                display: block;
                width: 100%;
                margin-bottom: 40px;
            }
            .team{
				width: 24%;
				min-width: 140px;
			}
            .teamicon{
				width: 30px;
				height: 30px;
			}
			.teamname{
				padding-left: 20px;
			}
			.selectable{
				cursor: pointer;
			}
			.selected{
				background-color: #dddddd;
			}
			.prono{
			    position: relative;
			}
			h3{
				margin-top: 0;
            }
            h3.result{
                margin-top: 0;
                margin-bottom: 0;
            }
        </style>

        <firebase-document app-name="prono" path="/[[pronoGroupId]]/competition/currentstage" data="{{currentStage}}"></firebase-document>
        <firebase-document app-name="prono" path="/[[pronoGroupId]]/competition/hometeam" data="{{team}}"></firebase-document>
        <firebase-query app-name="prono" path="/[[pronoGroupId]]/competition/stages" data="{{stages}}"></firebase-query>
        <firebase-document app-name="prono" path="/[[pronoGroupId]]/userpronos/[[pronoUserId]]/hometeamresult" data="{{prono}}"></firebase-document>

        <firebase-document id="document" app-name="prono"></firebase-document>

        <paper-material class$="{{_disabledClass(currentStage)}} prono selectable vertical layout" on-tap="editPronoDialog">
            <h3>{{localize('Team result')}}</h3>
            <div class="horizontal layout center wrap">
                <div class="team horizontal layout center">
                    <team-icon class="teamicon" prono-group-id="[[pronoGroupId]]" team-id="{{team}}"></team-icon>
                    <team-name class="teamname" prono-group-id="[[pronoGroupId]]" team-id="{{team}}"></team-name>
                </div>
                <div>
                    <h3 class="result">{{_parseResult(prono)}}</h3>
                </div>
            </div>
        </paper-material>

        <paper-dialog id="editPronoDialog" class="prono-dialog">
            <iron-form id="editPronoForm" on-iron-form-submit="editProno">
                <form>
                    <div class="horizontal layout center">
                        <team-icon class="teamicon" prono-group-id="[[pronoGroupId]]" team-id="{{team}}"></team-icon>
                        <team-name class="teamname" prono-group-id="[[pronoGroupId]]" team-id="{{team}}"></team-name>
                    </div>
                    <paper-dropdown-menu label="{{localize('Result')}}">
                        <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{newProno}}">
                            <paper-item value="-1"></paper-item>
                            <template is="dom-repeat" items="{{_getStages(stages)}}" as="stage">
                                <paper-item value="{{stage}}">{{_parseResult(stage)}}</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </form>
            </iron-form>

            <div class="buttons">
                <paper-button primary on-tap="editPronoFormSubmit" >save</paper-button>
                <paper-button secondary dialog-dismiss>cancel</paper-button>
            </div>
        </paper-dialog>

    </template>

    <script>
        class PronoTeamResult extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element){
            static get is() { return 'prono-team-result'; }

            static get properties() {
                return {
                    pronoGroupId: {
                        type: String,
                    },
                    pronoUserId: {
                        type: String,
                        value: '',
                    },
                    permission: {
                        type: Number,
                    },
                    language: {
                        value: 'nl-BE',
                    },
                    resources: {
                        value() {
                            return {
                                'en': {
                                    'Team result': 'Team Result',
                                    'Result': 'Result',
                                    'eliminated in the groupstage': 'geëlimineerd in de groepsfase',
                                    'eliminated in the round of ': 'geëlimineerd in de round of ',
                                    'eliminated in the round of 16': 'geëlimineerd in de 8e finale',
                                    'eliminated in the quarter-finals': 'geëlimineerd in de kwartfinale',
                                    'eliminated in the semi-finals': 'geëlimineerd in de halve finale',
                                    'eliminated in the final': 'geëlimineerd in de finale',
                                    'winner': 'winnaar',

                                },
                                'nl-BE': {
                                    'Team result': 'Team Resultaat',
                                    'Result': 'Result',
                                    'eliminated in the groupstage': 'geëlimineerd in de groepsfase',
                                    'eliminated in the round of ': 'geëlimineerd in de round of ',
                                    'eliminated in the round of 16': 'geëlimineerd in de 8e finale',
                                    'eliminated in the quarter-finals': 'geëlimineerd in de kwartfinale',
                                    'eliminated in the semi-finals': 'geëlimineerd in de halve finale',
                                    'eliminated in the final': 'geëlimineerd in de finale',
                                    'winner': 'winnaar',
                                }
                            }
                        }
                    },
                };
            }

            editPronoDialog(event){
                this.newProno = this.prono
                this.$.editPronoDialog.open();
            }
            editPronoFormSubmit(){
                this.$.editPronoForm.submit();
            }
            editProno(){
                this.$.editPronoDialog.close()
                if(this._hasValue(this.pronoUserId)){
                    this.$.document.path = '';
                    if(typeof this.newProno != 'undefined'){
                        this.$.document.path = '/'+this.pronoGroupId+'/userpronos/'+this.pronoUserId+'/hometeamresult';
                        this.$.document.data = this.newProno;
                        this.$.document.path = '';
                    }
                }
            }
            _parseResult(prono){
				prono = String(prono)
				var description = '';
				if(prono === "0"){
					description = this.localize('eliminated in the groupstage');
				}
				else if(parseInt(prono) > 16){
					description = this.localize('eliminated in the round of ')+result;
				}
				else if(prono === "16"){
					description = this.localize('eliminated in the round of 16');
				}
				else if(prono === "8"){
					description = this.localize('eliminated in the quarter-finals');
				}
				else if(prono === "4"){
					description = this.localize('eliminated in the semi-finals');
				}
				else if(prono === "2"){
					description = this.localize('eliminated in the final');
				}
				else if(prono === "1"){
					description = this.localize('winner');
				}
				return description;
			}

            _getStages(stages){
				var newStages = []
				for(var i=0; i<stages.length; i++){
				    newStages.push(stages[i].$key)
				}
				// sort
				newStages.sort(function(a,b){
				    return parseInt(b) - parseInt(a);
				});
				// shift the groupstage
				newStages.unshift(newStages.pop())
				// add the winner
				newStages.push('1');
				return newStages;
			}

            _hasValue(str){
                return str != ''
            }

            _disabledClass(currentStage){
                if(currentStage==0 || currentStage==-1){
					return '';
				}
				else{
					return 'disabled';
				}
            }
        }
        window.customElements.define(PronoTeamResult.is, PronoTeamResult);
    </script>

</dom-module>
