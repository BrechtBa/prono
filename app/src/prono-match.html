<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="team-name.html">
<link rel="import" href="team-icon.html">


<dom-module id="prono-match">
    <template>
        <style include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles"></style>
        <style>
            :host{
                display: block;
                width: 100%;
            }
            .score{
                width: 60px;
                text-align: center;
            }
            .teamicon{
                width: 30px;
                height: 30px;
            }
            .teamname.left{
                text-align: left;
            }
            .teamname.right{
                text-align: right;
            }
        </style>

        <firebase-document app-name="prono" path="/[[pronoGroupId]]/competition/matches/[[matchId]]" data="{{match}}"></firebase-document>
        <firebase-document app-name="prono" path="/[[pronoGroupId]]/competition/teams/[[match.team1]]" data="{{team1}}"></firebase-document>
        <firebase-document app-name="prono" path="/[[pronoGroupId]]/competition/teams/[[match.team2]]" data="{{team2}}"></firebase-document>

        <template is="dom-if" if="{{_hasValue(pronoUserId)}}">
            <firebase-document app-name="prono" path="/[[pronoGroupId]]/userpronos/[[pronoUserId]]/matches/[[matchId]]" data="{{prono}}"></firebase-document>
        </template>


        <div class="match horizontal layout center center-justified" on-tap="editScore">
            <div class="teamname left flex">
                <team-name team="{{team1}}" default="{{match.defaultteam1}}"></team-name>
            </div>
            <div>
                <team-icon class="teamicon" team="{{team1}}"></team-icon>
            </div>
            <div class="score">
                <template is="dom-if" if="{{_hasValue(pronoUserId)}}">
                    {{_formatScore(pronoMatch.score1)}} - {{_formatScore(pronoMatch.score2)}}
                </template>
                <template is="dom-if" if="{{!_hasValue(pronoUserId)}}">
                    {{_formatScore(match.score1)}} - {{_formatScore(match.score2)}}
                </template>
            </div>
            <div>
                <team-icon class="teamicon" team="{{team2}}"></team-icon>
            </div>
            <div class="teamname right flex">
                <team-name team="{{team2}}" default="{{match.defaultteam2}}"></team-name>
            </div>
        </div>

<!--
        <prono-score-dialog id="editScore" teams-model="{{teamsModel}}" matches-model="{{matchesModel}}" result="{{result}}" on-save="saveScore"></prono-score-dialog>
-->

    </template>

    <script>
        class PronoMatch extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element){
            static get is() { return 'prono-match'; }

            static get properties() {
                return {
                    pronoGroupId: {
                        type: String,
                    },
                    matchId: {
                        type: String,
                    },
                    pronoUserId: {
                        type: String,
                        value: '',
                    },
                    groupstage: {
                        type: Boolean,
                    },
                    language: {
                        value: 'nl-BE',
                    },
                    resources: {
                        value() {
                            return {
                                'en': { 'groupname': 'Group {group}' },
                                'nl-BE': { 'groupname': 'Groep {group}' }
                            }
                        }
                    },
                };
            }

            _formatScore(score){
                if(score>-1){
                    return score;
                }
            }

            _disabledClass(currentStage,user){
                return '';
                if(currentStage==0 || currentStage==-1 || typeof user.id == 'undefined'){
                    return '';
                }
                else{
                    return 'disabled';
                }
            }

            _hasValue(str){
                return str != ''
            }

        }

        window.customElements.define(PronoMatch.is, PronoMatch);


        /*
        Polymer({
            is: 'prono-groupstage',
            properties: {
                token:{
                    type: 'String',
                    value: ''
                },
                permission: {
                    type: 'Number',
                    value: 1
                },
                tokenPayload: {
                    type: 'Object'
                },
                groupsModel: {
                    type: 'Array'
                },
                teamsModel: {
                    type: 'Array'
                },
                matchesModel: {
                    type: 'Array',
                },
                matchresultsModel: {
                    type: 'Array',
                },
                currentStage:{
                    type: 'Number',
                    value: 1
                },
                user: {
                    type: 'Object',
                    value: {}
                },
                databasePrepared: {
                    type: 'Number',
                },
                groupwinnersStatus: {
                    type: 'Array',
                    value: [],
                },
            },
            observers:[
                'getProno(token,user,databasePrepared)',
                'getResults(user,matchresultsModel,prono)'
            ],
            created: function(){
                // create the local dictionary
                this.dictionary = {};
                this.dictionary['Group'] = {'nl':'Groep'};
            },
            ready: function(){
                console.log('ready');
                var that = this;
                document.addEventListener('clear-prono', function(e){
                    that.prono = [];
                });
            },
            getProno: function(token,user,databasePrepared){
                console.log('get groupstage prono')
                if(databasePrepared!=1 || typeof user.id == 'undefined' || token == '' ){
                    this.prono = [];
                }
                else{
                    this.$.prono.get('?user='+user.id);
                }
            },
            getResults: function(user,matchresultsModel,prono){
                if(typeof user.id != 'undefined'){
                    this.results = this.prono.filter(function(prono){
                        return (prono.user == user.id);
                    });
                }
                else{
                    this.results = matchresultsModel;
                }
            },
            editScore: function(e){
                var match = e.model.__data__.match;
                if( (typeof this.user.id == 'undefined' && this.permission > 5) || ( typeof this.user.id != 'undefined' && match.stage==this.currentStage ) || (typeof this.user.id!='undefined' && this.currentStage==-1 && this.permission > 6)  ){
                    
                    var that = this;
                    that.result = {}
                    // find the result in the results list
                    that.results.forEach(function(result){
                        if( typeof result.user == 'undefined'){ 
                            if(result.id==match.id){
                                that.result = result;
                            }
                        }
                        else{
                            if(result.match==match.id){
                                that.result = result;
                            }
                        }
                    });
                    this.$.editScore.open();
                }
            },
            saveScore: function(e){
                if(typeof this.user.id != 'undefined'){
                    this.$.prono.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2});    
                }
                else{
                    app.$.model.$.matchresultsModel.put(e.detail.id+'/',{'score1':e.detail.score1,'score2':e.detail.score2});
                }
            },
            filterGroupMatches: function(group){
                return function(item){
                    return (item.group == group.id);
                  };
            },
            filterGroupstageProno: function(prono,matchesModel){

                var matchids = [];
                matchesModel.forEach(function(m){
                    if(m.stage==0){
                        matchids.push(m.id)
                    }
                });

                return prono.filter(function(p){
                    return (p.match in matchids);
                });
            },

            getTeam: function(id,teams){
                var team = {};
                teams.forEach(function(item){
                    if(item.id == id){
                        team = item;
                    }
                });
                return team;
            },
            getScore1: function(match,results){
                var score = -1;
                results.forEach(function(item){
                    if(item.match == match.id){
                        score = item.score1
                    }
                });
                return this.formatScore(score);
            },
            getScore2: function(match,results){
                var score = -1;
                results.forEach(function(item){
                    if(item.match == match.id){
                        score = item.score2
                    }
                });
                return this.formatScore(score)
            },
            formatScore: function(score){
                var val = '';
                if(score<0){
                    val = '';
                }
                else{
                    val = score;
                }
                return val;
            },
            handlePronoChange: function(){

            },
            groupwinnerStatusChanged: function(e){
                var tempstatus = [];
                this.groupsModel.forEach(function(group){
                    tempstatus.push(group.status);
                });

                this.groupwinnersStatus = tempstatus;
            },
            computePronoStatus: function(groupstageResultsStatus,groupwinnersStatus){
                var status = groupstageResultsStatus;

                groupwinnersStatus.forEach(function(s){
                    if(s==0){
                        status = 0;
                    }
                });
                return status;
            },
            _displayStatus: function(prono){
                return prono.length!=0;
            },
            _sortMatches: function(a, b) {  
  
                if(parseInt(a.date) > parseInt(b.date)){
                    return 1;
                }
                else if(parseInt(a.date) < parseInt(b.date)){
                    return -1;
                }
                else{
                    return 0;
                }
            },
            trans: function(key){
                return app.trans(key,this.dictionary);
            },
            formatDate: function(timestamp){
                var date = new Date(timestamp * 1000);
                var day = date.getDate();
                var month = (date.getMonth()+1)
                var year = date.getFullYear();
                var hours = date.getHours();
                var minutes = date.getMinutes();
                return (day < 10? '0' : '') + day + '-' + (month < 10? '0' : '') + month + '-' + date.getFullYear() + ' ' + (hours < 10? '0' : '') + hours + ':' +  (minutes < 10? '0' : '') + minutes;
            },
        });
        */
    </script>

</dom-module>
